{% extends 'base.html' %}

{% block content %}
<div class="container">
  <h1>Painel de Monitoramento da API</h1>
  <p>A cada 30s, atualizamos a tabela com seus últimos logs (ou todos, se você for admin).</p>

  <table class="table table-striped" id="logsTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>Token</th>
        <th>Path</th>
        <th>Método</th>
        <th>Status</th>
        <th>Tempo (s)</th>
        <th>Data/Hora</th>
      </tr>
    </thead>
    <tbody>
      <!-- Linhas serão preenchidas dinamicamente via JavaScript -->
    </tbody>
  </table>
</div>

<script>
function fetchData() {
  // Usar URL nomeada com namespace
  fetch("{% url 'api:monitoring_data' %}")
    .then(response => response.json())
    .then(data => {
      const logs = data.logs;
      const tbody = document.querySelector("#logsTable tbody");
      tbody.innerHTML = "";
      logs.forEach(log => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${log.id}</td>
          <td>${log.user_token || ''}</td>
          <td>${log.path}</td>
          <td>${log.method}</td>
          <td>${log.status_code}</td>
          <td>${log.execution_time}</td>
          <td>${log.timestamp}</td>
        `;
        tbody.appendChild(tr);
      });
    })
    .catch(err => console.error("Erro ao carregar dados de monitoramento:", err));
}

// Chamada inicial
fetchData();
// Polling a cada 30 segundos
setInterval(fetchData, 30000);
</script>
{% endblock %}
