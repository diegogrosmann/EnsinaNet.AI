{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container py-4">
    <div class="bs-component">
        <!-- Card Principal -->
        <div class="card border-primary mb-3">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h2 class="card-title mb-0">
                    <i class="bi bi-graph-up me-2"></i>Dashboard de Monitoramento
                </h2>
                <div>
                    <button id="refresh-btn" class="btn btn-light">
                        <i class="bi bi-arrow-repeat me-1"></i>Atualizar
                    </button>
                </div>
            </div>

            <div class="card-body">
                <!-- Indicadores principais -->
                <div class="row mb-4">
                    <div class="col-md-3 mb-3 mb-md-0">
                        <div class="card bg-light h-100">
                            <div class="card-body text-center">
                                <h3 class="display-4" id="total-requests">0</h3>
                                <p class="lead mb-0">Requisições Totais</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3 mb-md-0">
                        <div class="card bg-success text-white h-100">
                            <div class="card-body text-center">
                                <h3 class="display-4" id="success-count">0</h3>
                                <p class="lead mb-0">Sucesso</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3 mb-md-0">
                        <div class="card bg-danger text-white h-100">
                            <div class="card-body text-center">
                                <h3 class="display-4" id="error-count">0</h3>
                                <p class="lead mb-0">Erros</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3 mb-md-0">
                        <div class="card bg-info text-white h-100">
                            <div class="card-body text-center">
                                <h3 class="display-4" id="avg-time">0ms</h3>
                                <p class="lead mb-0">Tempo Médio</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filtros -->
                <div class="card bg-light mb-4">
                    <div class="card-body">
                        <div class="row align-items-end">
                            <div class="col-md-4 mb-3 mb-md-0">
                                <label for="filter-token" class="form-label">Token</label>
                                <select id="filter-token" class="form-select">
                                    <option value="">Todos os tokens</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3 mb-md-0">
                                <label for="filter-date-start" class="form-label">Data Inicial</label>
                                <input type="date" id="filter-date-start" class="form-control">
                            </div>
                            <div class="col-md-3 mb-3 mb-md-0">
                                <label for="filter-date-end" class="form-label">Data Final</label>
                                <input type="date" id="filter-date-end" class="form-control">
                            </div>
                            <div class="col-md-2 text-md-end">
                                <button id="apply-filters" class="btn btn-primary w-100">
                                    <i class="bi bi-funnel me-1"></i>Filtrar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gráficos -->
                <div class="row mb-4">
                    <div class="col-md-6 mb-3 mb-md-0">
                        <div class="card h-100">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Requisições por Hora</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="requests-chart" height="250"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3 mb-md-0">
                        <div class="card h-100">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Taxa de Sucesso</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="success-rate-chart" height="250"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabela de Últimas Requisições -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Últimas Requisições</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover table-striped" id="requests-table">
                                <thead>
                                    <tr>
                                        <th>Data/Hora</th>
                                        <th>Token</th>
                                        <th>Endpoint</th>
                                        <th>Status</th>
                                        <th>Tempo</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Dados serão carregados via AJAX -->
                                    <tr class="placeholder-row">
                                        <td colspan="6" class="text-center">Carregando dados...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="d-flex justify-content-between mt-3">
                            <div id="table-info">Mostrando 0 de 0 registros</div>
                            <nav aria-label="Paginação">
                                <ul class="pagination pagination-sm" id="pagination">
                                    <li class="page-item disabled">
                                        <a class="page-link" href="#" aria-label="Anterior" id="prev-page">
                                            <span aria-hidden="true">&laquo;</span>
                                        </a>
                                    </li>
                                    <li class="page-item disabled">
                                        <a class="page-link" href="#" aria-label="Próximo" id="next-page">
                                            <span aria-hidden="true">&raquo;</span>
                                        </a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Detalhes -->
<div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detailsModalLabel">Detalhes da Requisição</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <h6>Informações Gerais</h6>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <strong>ID:</strong> <span id="detail-id"></span>
                        </div>
                        <div class="col-md-6">
                            <strong>Data/Hora:</strong> <span id="detail-timestamp"></span>
                        </div>
                        <div class="col-md-6">
                            <strong>Token:</strong> <span id="detail-token"></span>
                        </div>
                        <div class="col-md-6">
                            <strong>Endpoint:</strong> <span id="detail-endpoint"></span>
                        </div>
                        <div class="col-md-6">
                            <strong>Status:</strong> <span id="detail-status"></span>
                        </div>
                        <div class="col-md-6">
                            <strong>Tempo:</strong> <span id="detail-time"></span>
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <h6>Headers</h6>
                    <div class="bg-light p-2 rounded">
                        <pre id="detail-headers" class="mb-0"></pre>
                    </div>
                </div>
                <div class="mb-3">
                    <h6>Request</h6>
                    <div class="bg-light p-2 rounded">
                        <pre id="detail-request" class="mb-0"></pre>
                    </div>
                </div>
                <div class="mb-3">
                    <h6>Response</h6>
                    <div class="bg-light p-2 rounded">
                        <pre id="detail-response" class="mb-0"></pre>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Estado global
    let currentPage = 1;
    let totalPages = 1;
    let filters = {
        token_id: '',  // Alterado de 'token' para 'token_id'
        start_date: '',
        end_date: ''
    };
    
    // URL nomeadas para APIs
    const URLS = {
        stats: "{% url 'api:monitoring_stats' %}",
        requests: "{% url 'api:monitoring_requests' %}",
        requestDetails: "{% url 'api:monitoring_request_details' 0 %}".replace('0', '') // Base URL para detalhes
    };
    
    // Charts
    let requestsChart = null;
    let successRateChart = null;

    // Inicializar os gráficos
    function initCharts() {
        // Configuração para o gráfico de requisições por hora
        const requestsCtx = document.getElementById('requests-chart').getContext('2d');
        requestsChart = new Chart(requestsCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Total de Requisições',
                    data: [],
                    borderColor: 'rgba(54, 162, 235, 1)',
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    tension: 0.1,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                }
            }
        });

        // Configuração para o gráfico de taxa de sucesso
        const successRateCtx = document.getElementById('success-rate-chart').getContext('2d');
        successRateChart = new Chart(successRateCtx, {
            type: 'doughnut',
            data: {
                labels: ['Sucesso', 'Erro'],
                datasets: [{
                    data: [0, 0],
                    backgroundColor: [
                        'rgba(40, 167, 69, 0.8)',
                        'rgba(220, 53, 69, 0.8)'
                    ],
                    borderColor: [
                        'rgba(40, 167, 69, 1)',
                        'rgba(220, 53, 69, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }

    // Carregar todos os dados
    function loadDashboardData() {
        showLoading();
        
        // Construir parâmetros para a requisição
        let params = {};
        if (filters.token_id) params.token_id = filters.token_id;
        if (filters.start_date) params.start_date = filters.start_date;
        if (filters.end_date) params.end_date = filters.end_date;
        
        ajaxAPI(URLS.stats, 'GET', params, {
            successMessage: null,
            showLoading: true
        })
        .then(apiResponse => {
            if (apiResponse.isSuccess()) {
                // Obter dados do primeiro elemento do array
                const responseData = apiResponse.getData()[0];
                
                // Preencher indicadores
                document.getElementById('total-requests').textContent = responseData.total_calls || 0;
                
                // Calcular contagens de sucesso e erro a partir da distribuição de status
                let successCount = 0;
                let errorCount = 0;
                
                if (responseData.status_distribution) {
                    responseData.status_distribution.forEach(status => {
                        if (status.status_code < 400) {
                            successCount += status.count;
                        } else {
                            errorCount += status.count;
                        }
                    });
                }
                
                document.getElementById('success-count').textContent = successCount;
                document.getElementById('error-count').textContent = errorCount;
                document.getElementById('avg-time').textContent = `${Math.round(responseData.avg_time || 0)}ms`;
                
                // Atualizar gráficos
                updateCharts(responseData, successCount, errorCount);
                
                // Carregar lista de tokens para o filtro se não houver filtro aplicado
                if (!filters.token_id) {
                    loadTokenOptions(responseData.tokens || []);
                }
            } else {
                const error = apiResponse.getError();
                showMessage('error', error?.message || 'Erro ao carregar estatísticas');
            }
        })
        .catch(error => {
            console.error('Erro ao carregar dados:', error);
            showMessage('error', 'Erro ao carregar dados do dashboard');
        })
        .finally(() => {
            loadRequestsTable(1);
        });
    }

    // Atualizar os gráficos com novos dados
    function updateCharts(data, successCount, errorCount) {
        // Atualizar gráfico de requisições por hora (usando daily_calls)
        if (requestsChart) {
            const dailyData = { labels: [], values: [] };
            
            if (data.daily_calls && Array.isArray(data.daily_calls)) {
                data.daily_calls.forEach(item => {
                    dailyData.labels.push(item.day);
                    dailyData.values.push(item.count);
                });
            }
            
            requestsChart.data.labels = dailyData.labels;
            requestsChart.data.datasets[0].data = dailyData.values;
            requestsChart.update();
        }
        
        // Atualizar gráfico de taxa de sucesso
        if (successRateChart) {
            successRateChart.data.datasets[0].data = [successCount, errorCount];
            successRateChart.update();
        }
    }

    // Carregar lista de tokens para o filtro
    function loadTokenOptions(tokens) {
        const tokenSelect = document.getElementById('filter-token');
        tokenSelect.innerHTML = '<option value="">Todos os tokens</option>';
        
        tokens.forEach(token => {
            const option = document.createElement('option');
            option.value = token.id;
            option.textContent = token.name;
            tokenSelect.appendChild(option);
        });
    }

    // Carregar tabela de requisições
    function loadRequestsTable(page = 1) {
        currentPage = page;
        
        // Construir parâmetros para a requisição
        let params = { page: page };
        if (filters.token_id) params.token_id = filters.token_id;
        if (filters.start_date) params.start_date = filters.start_date;
        if (filters.end_date) params.end_date = filters.end_date;
        
        ajaxAPI(URLS.requests, 'GET', params, {
            successMessage: null,
            showLoading: true
        })
        .then(apiResponse => {
            hideLoading();
            
            if (apiResponse.isSuccess()) {
                // Obter dados do primeiro elemento do array
                const responseData = apiResponse.getData()[0];
                renderRequestsTable(responseData);
            } else {
                const error = apiResponse.getError();
                showMessage('error', error?.message || 'Erro ao carregar requisições');
                document.querySelector('#requests-table tbody').innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center">Erro ao carregar dados</td>
                    </tr>
                `;
            }
        })
        .catch(error => {
            hideLoading();
            console.error('Erro ao carregar requisições:', error);
            showMessage('error', 'Erro ao carregar tabela de requisições');
            document.querySelector('#requests-table tbody').innerHTML = `
                <tr>
                    <td colspan="6" class="text-center">Erro ao carregar dados</td>
                </tr>
            `;
        });
    }

    // Renderizar tabela de requisições
    function renderRequestsTable(data) {
        const tableBody = document.querySelector('#requests-table tbody');
        const requests = data.requests || [];
        totalPages = data.total_pages || 1;
        
        // Atualizar informação de paginação
        document.getElementById('table-info').textContent = `Mostrando ${data.page > 0 ? ((data.page-1) * data.per_page) + 1 : 0} a ${Math.min(data.page * data.per_page, data.total)} de ${data.total || 0} registros`;
        
        // Atualizar controles de paginação
        updatePagination();
        
        if (requests.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center">Nenhuma requisição encontrada</td>
                </tr>
            `;
            return;
        }
        
        tableBody.innerHTML = '';
        
        requests.forEach(req => {
            const row = document.createElement('tr');
            
            // Status com cor apropriada
            const statusClass = req.status_code < 400 ? 'text-success' : 'text-danger';
            
            row.innerHTML = `
                <td>${formatDateTime(req.timestamp)}</td>
                <td>${req.token?.name || '-'}</td>
                <td>${req.path || '-'}</td>
                <td><span class="${statusClass}">${req.status_code}</span></td>
                <td>${req.execution_time}ms</td>
                <td>
                    <button class="btn btn-sm btn-info view-details" data-id="${req.id}">
                        <i class="bi bi-eye"></i>
                    </button>
                </td>
            `;
            
            tableBody.appendChild(row);
        });
        
        // Adicionar listeners para os botões de detalhes
        document.querySelectorAll('.view-details').forEach(button => {
            button.addEventListener('click', function() {
                const requestId = this.getAttribute('data-id');
                showRequestDetails(requestId);
            });
        });
    }

    // Atualizar controles de paginação
    function updatePagination() {
        const pagination = document.getElementById('pagination');
        const prevPageBtn = document.getElementById('prev-page').parentElement;
        const nextPageBtn = document.getElementById('next-page').parentElement;
        
        // Atualizar estado dos botões de navegação
        prevPageBtn.classList.toggle('disabled', currentPage <= 1);
        nextPageBtn.classList.toggle('disabled', currentPage >= totalPages);
        
        // Remover páginas existentes
        Array.from(pagination.querySelectorAll('li:not(:first-child):not(:last-child)')).forEach(li => li.remove());
        
        // Gerar números de página
        let pagesToShow = [];
        if (totalPages <= 5) {
            pagesToShow = Array.from({length: totalPages}, (_, i) => i + 1);
        } else {
            pagesToShow = [1];
            
            if (currentPage > 3) {
                pagesToShow.push('...');
            }
            
            for (let i = Math.max(2, currentPage - 1); i <= Math.min(totalPages - 1, currentPage + 1); i++) {
                pagesToShow.push(i);
            }
            
            if (currentPage < totalPages - 2) {
                pagesToShow.push('...');
            }
            
            if (totalPages > 1) {
                pagesToShow.push(totalPages);
            }
        }
        
        // Inserir links de página no DOM
        const nextPageElement = pagination.querySelector('li:last-child');
        if (!nextPageElement) return;
        
        pagesToShow.forEach(pageNum => {
            const li = document.createElement('li');
            
            if (pageNum === '...') {
                li.className = 'page-item disabled';
                li.innerHTML = '<span class="page-link">...</span>';
            } else {
                li.className = `page-item ${currentPage === pageNum ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" data-page="${pageNum}">${pageNum}</a>`;
                
                if (currentPage !== pageNum) {
                    li.querySelector('a').addEventListener('click', function(e) {
                        e.preventDefault();
                        loadRequestsTable(parseInt(this.dataset.page));
                    });
                }
            }
            
            pagination.insertBefore(li, nextPageElement);
        });
    }

    // Mostrar detalhes da requisição
    function showRequestDetails(requestId) {
        const url = URLS.requestDetails + requestId + '/';
        
        ajaxAPI(url, 'GET', {}, {
            successMessage: null,
            showLoading: true
        })
        .then(apiResponse => {
            if (apiResponse.isSuccess()) {
                // Obter dados do primeiro elemento do array se for array
                const request = Array.isArray(apiResponse.getData()) 
                    ? apiResponse.getData()[0] 
                    : apiResponse.getData();
                
                // Preencher o modal com os detalhes
                document.getElementById('detail-id').textContent = request.id;
                document.getElementById('detail-timestamp').textContent = formatDateTime(request.timestamp);
                document.getElementById('detail-token').textContent = request.token?.name || '-';
                document.getElementById('detail-endpoint').textContent = request.path || '-';
                
                const statusElement = document.getElementById('detail-status');
                statusElement.textContent = request.status_code;
                statusElement.className = request.status_code < 400 ? 'text-success' : 'text-danger';
                
                document.getElementById('detail-time').textContent = `${request.execution_time}ms`;
                
                // Formatar os dados JSON para exibição
                document.getElementById('detail-headers').textContent = formatJSON(request.headers);
                document.getElementById('detail-request').textContent = formatJSON(request.request_body);
                document.getElementById('detail-response').textContent = formatJSON(request.response_body);
                
                // Exibir o modal
                const detailsModal = new bootstrap.Modal(document.getElementById('detailsModal'));
                detailsModal.show();
            } else {
                const error = apiResponse.getError();
                showMessage('error', error?.message || 'Erro ao carregar detalhes da requisição');
            }
        })
        .catch(error => {
            console.error('Erro ao carregar detalhes:', error);
            showMessage('error', 'Erro ao carregar detalhes da requisição');
        });
    }

    // Funções auxiliares
    function formatDateTime(timestamp) {
        if (!timestamp) return '-';
        const date = new Date(timestamp);
        return date.toLocaleString();
    }
    
    function formatJSON(jsonData) {
        try {
            if (typeof jsonData === 'string') {
                jsonData = JSON.parse(jsonData);
            }
            return JSON.stringify(jsonData, null, 2);
        } catch (e) {
            return jsonData || '-';
        }
    }
    
    // Event listeners
    document.getElementById('refresh-btn').addEventListener('click', function() {
        loadDashboardData();
    });
    
    document.getElementById('apply-filters').addEventListener('click', function() {
        filters = {
            token_id: document.getElementById('filter-token').value,  // Nome corrigido
            start_date: document.getElementById('filter-date-start').value,
            end_date: document.getElementById('filter-date-end').value
        };
        loadDashboardData();
    });
    
    document.getElementById('prev-page').addEventListener('click', function(e) {
        e.preventDefault();
        if (currentPage > 1) {
            loadRequestsTable(currentPage - 1);
        }
    });
    
    document.getElementById('next-page').addEventListener('click', function(e) {
        e.preventDefault();
        if (currentPage < totalPages) {
            loadRequestsTable(currentPage + 1);
        }
    });

    // Inicialização
    initCharts();
    loadDashboardData();
});
</script>
{% endblock %}

{% block extra_styles %}
<style>
    .chart-container {
        position: relative;
        height: 250px;
        width: 100%;
    }
    
    pre {
        white-space: pre-wrap;
        word-wrap: break-word;
        font-size: 0.85rem;
        max-height: 200px;
        overflow-y: auto;
    }
    
    .placeholder-row td {
        padding: 2rem 0;
        text-align: center;
        color: #666;
    }
    
    .view-details {
        padding: 0.25rem 0.5rem;
    }
</style>
{% endblock %}
