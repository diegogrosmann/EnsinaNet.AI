{% extends 'base.html' %}

{% block content %}
<div class="container py-4">
    <div class="bs-component">
        <!-- Card Principal usando estrutura padrão do Bootswatch -->
        <div class="card border-primary mb-3">
            <!-- Header do Card com estilo Bootswatch -->
            <div class="card-header d-flex justify-content-between align-items-center">
                <h2 class="card-title mb-0">
                    <i class="bi bi-cpu me-2"></i>
                    Gerenciamento de IAs
                </h2>
                <a href="{% url 'ai_config:ai_create' %}" class="btn btn-success">
                    <i class="bi bi-plus-circle"></i> Nova IA
                </a>
            </div>

            <!-- Corpo do Card -->
            <div class="card-body">
                {% if ai_clients %}
                <div class="mb-3">
                    <!-- Filtros e Controles com componentes Bootswatch -->
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3 gap-2">
                        <!-- Controles à esquerda -->
                        <div class="d-flex align-items-center mb-2 mb-md-0 flex-wrap gap-2">
                            <button class="btn btn-sm btn-outline-primary toggle-filters" type="button" aria-expanded="true" aria-controls="filterControls">
                                <i class="bi bi-funnel me-1"></i>Filtros
                                <i class="bi bi-chevron-down ms-1"></i>
                            </button>
                            
                            <!-- Informação de paginação -->
                            <div class="text-muted d-none d-sm-block">
                                Mostrando <span id="paginationFrom">1</span> a <span id="paginationTo">10</span> de <span id="paginationTotal">{{ ai_clients|length }}</span>
                            </div>
                        </div>
                        
                        <!-- Controles à direita -->
                        <div class="input-group input-group-sm" style="width: auto; min-width: 120px; max-width: 250px;">
                            <span class="input-group-text">Por página</span>
                            <select id="itemsPerPage" class="form-select form-select-sm" style="min-width: 70px;">
                                <option value="5">5</option>
                                <option value="10" selected>10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                    </div>

                    <!-- Filtros Expandidos -->
                    <div class="card bg-light mb-3" id="filterControls">
                        <div class="card-body">
                            <div class="row g-3">
                                <!-- Filtro por Nome -->
                                <div class="col-12 col-md-6">
                                    <label for="searchInput" class="form-label">Nome da IA</label>
                                    <input type="text" 
                                           id="searchInput" 
                                           class="form-control form-control-sm filter" 
                                           placeholder="Filtrar por nome..."
                                           value="{{ search_query }}">
                                </div>
                                
                                <!-- Filtro por Cliente de API -->
                                <div class="col-12 col-md-6">
                                    <label for="apiFilter" class="form-label">Cliente API</label>
                                    <select id="apiFilter" class="form-select form-select-sm filter">
                                        <option value="">Todos os clientes</option>
                                        {% for api in api_types %}
                                            <option value="{{ api }}">{{ api }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tabela Responsiva no estilo Bootswatch -->
                    <div class="table-responsive" id="tableContainer">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th scope="col" class="sortable" data-sort-key="name">
                                        Nome
                                        <i class="sort-icon bi bi-sort-alpha-down"></i>
                                    </th>
                                    <th scope="col" class="sortable d-none d-md-table-cell" data-sort-key="client">
                                        Cliente IA
                                        <i class="sort-icon bi bi-sort-alpha-down"></i>
                                    </th>
                                    <th scope="col" class="sortable d-none d-md-table-cell" data-sort-key="model">
                                        Modelo
                                        <i class="sort-icon bi bi-sort-alpha-down"></i>
                                    </th>
                                    <th scope="col" class="text-end">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for ai in ai_clients %}
                                <tr data-api-type="{{ ai.ai_client }}">
                                    <th scope="row">
                                        <a href="{% url 'ai_config:ai_edit' ai.id %}" class="text-decoration-none">
                                            {{ ai.name }}
                                        </a>
                                        <!-- Informações extras para telas pequenas -->
                                        <div class="d-md-none mt-1">
                                            <small class="d-block text-muted">
                                                <strong>Cliente:</strong> {{ ai.ai_client }}
                                            </small>
                                            <small class="d-block text-muted">
                                                <strong>Modelo:</strong> <span class="badge bg-secondary">{{ ai.model_name|default:"Padrão" }}</span>
                                            </small>
                                        </div>
                                    </th>
                                    <td class="d-none d-md-table-cell">{{ ai.ai_client }}</td>
                                    <td class="d-none d-md-table-cell">
                                        <span class="badge bg-secondary">{{ ai.model_name|default:"Padrão" }}</span>
                                    </td>
                                    <td class="text-end">
                                        <div class="btn-group">
                                            <button class="btn btn-sm btn-primary" 
                                                    onclick="openLinkModal('{{ ai.id }}', '{{ ai.name }}')"
                                                    title="Gerenciar tokens">
                                                <i class="bi bi-link"></i>
                                            </button>
                                            <button class="btn btn-sm btn-danger" 
                                                    onclick="confirmDelete('{{ ai.id }}', '{{ ai.name }}')"
                                                    title="Excluir IA">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Paginação no estilo Bootswatch -->
                    <nav aria-label="Paginação da tabela de IAs" class="mt-3">
                        <ul class="pagination pagination-sm justify-content-center" id="pagination">
                            <li class="page-item disabled">
                                <a class="page-link" href="#" id="prevPage" aria-label="Página anterior">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                            <!-- Páginas serão inseridas aqui via JavaScript -->
                            <li class="page-item">
                                <a class="page-link" href="#" id="nextPage" aria-label="Próxima página">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                        </ul>
                    </nav>
                </div>
                {% else %}
                <!-- Feedback quando não há IAs configuradas usando alerta do Bootswatch -->
                <div class="alert alert-info" role="alert">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-info-circle-fill me-2"></i>
                        <div>
                            {% if search_query %}
                            <h5 class="alert-heading mb-1">Nenhum resultado</h5>
                            <p class="mb-0">Nenhuma IA encontrada com o termo "{{ search_query }}".
                                <a href="{% url 'ai_config:ai_manage' %}" class="alert-link">Limpar busca</a>
                            </p>
                            {% else %}
                            <h5 class="alert-heading mb-1">Sem configurações</h5>
                            <p class="mb-0">Nenhuma IA configurada. Clique em "Nova IA" para adicionar.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmação de Exclusão (Estilo Bootswatch) -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteModalLabel">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Confirmar Exclusão
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja excluir a IA "<span id="aiNameToDelete" class="fw-bold"></span>"?</p>
                <p class="text-muted small">Esta ação não pode ser desfeita.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">
                    <i class="bi bi-trash me-1"></i> Excluir
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Vincular Tokens (Estilo Bootswatch) -->
<div class="modal fade" id="linkTokenModal" tabindex="-1" aria-labelledby="linkTokenModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="linkTokenModalLabel">
                    <i class="bi bi-link me-2"></i>
                    Vincular Tokens à IA: <span id="aiNameForTokens"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Estado de carregamento -->
                <div class="modal-loading text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p class="mt-2">Carregando tokens disponíveis...</p>
                </div>
                
                <!-- Estado de erro -->
                <div class="modal-error alert alert-danger d-none">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        <div>
                            <h5 class="alert-heading mb-1">Erro</h5>
                            <p class="mb-0">Erro ao carregar tokens. Por favor, tente novamente.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Container de tokens -->
                <div class="tokens-container d-none">
                    <div class="alert alert-info mb-3">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-info-circle-fill me-2"></i>
                            <div>
                                <p class="mb-0">Selecione os tokens que podem utilizar esta IA. As alterações são salvas automaticamente.</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Lista de tokens -->
                    <div class="list-group token-list">
                        <!-- Lista de tokens será carregada dinamicamente -->
                    </div>
                    
                    <!-- Estado vazio -->
                    <div class="no-tokens text-center py-4 d-none">
                        <i class="bi bi-exclamation-circle text-warning" style="font-size: 2rem;"></i>
                        <p class="mt-2">Você ainda não tem tokens disponíveis.</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<script>
let deleteModal;
let linkTokenModal;
let aiIdToDelete;
let currentAiId;
let currentPage = 1;
let itemsPerPage = 10;
let filteredRows = [];
let sortKey = 'name';
let sortDirection = 'asc';

// Função para verificar se um elemento existe antes de executar uma ação
function safelyExecute(selector, action) {
    const element = document.querySelector(selector);
    if (element) {
        action(element);
        return true;
    }
    return false;
}

document.addEventListener('DOMContentLoaded', function() {
    // Inicializar modais
    deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
    linkTokenModal = new bootstrap.Modal(document.getElementById('linkTokenModal'));
    
    // Primeiro restaurar as preferências do usuário
    restoreUserPreferences();
    
    // Restaurar estado dos filtros
    restoreFiltersState();
    
    // Inicializar ordenamento e paginação
    initTableSorting();
    
    // Inicializar contadores de paginação e gerar paginação inicial
    updateDisplayedTable();
    
    // Configurar eventos para filtros e paginação
    setupEventListeners();
    
    // Configurar botões de ação para excluir e vincular tokens
    setupActionButtons();
});

function setupEventListeners() {
    // Botão para limpar busca (se existir)
    safelyExecute('#clearSearchBtn', (element) => {
        element.addEventListener('click', clearSearch);
    });
    
    // Evento de entrada de texto para busca
    safelyExecute('#searchInput', (element) => {
        element.addEventListener('input', debounce(() => {
            currentPage = 1;
            updateDisplayedTable();
        }, 300));
    });
    
    // Evento para filtro de API
    safelyExecute('#apiFilter', (element) => {
        element.addEventListener('change', function() {
            currentPage = 1;
            updateDisplayedTable();
        });
    });
    
    // Eventos para paginação
    safelyExecute('#prevPage', (element) => {
        element.addEventListener('click', function(e) {
            e.preventDefault();
            if (currentPage > 1) {
                currentPage--;
                updateDisplayedTable();
            }
        });
    });
    
    safelyExecute('#nextPage', (element) => {
        element.addEventListener('click', function(e) {
            e.preventDefault();
            const totalPages = Math.ceil(filteredRows.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                updateDisplayedTable();
            }
        });
    });
    
    // Evento para itens por página
    safelyExecute('#itemsPerPage', (element) => {
        element.addEventListener('change', function() {
            itemsPerPage = parseInt(this.value);
            currentPage = 1;
            sessionStorage.setItem('aiTableItemsPerPage', itemsPerPage);
            updateDisplayedTable();
        });
    });
    
    // Evento para toggle de filtros
    safelyExecute('.toggle-filters', (element) => {
        element.addEventListener('click', toggleFilters);
    });
    
    // Remover chamada para restoreUserPreferences pois agora é chamada no início do carregamento
}

function setupActionButtons() {
    // Botão para confirmar exclusão
    safelyExecute('#confirmDelete', (element) => {
        element.addEventListener('click', handleDeleteConfirm);
    });
}

function toggleFilters() {
    const filterControls = document.querySelector('#filterControls');
    const icon = document.querySelector('.toggle-filters i:last-child');
    
    if (filterControls && icon) {
        if (filterControls.style.display === 'none') {
            filterControls.style.display = 'block';
            icon.classList.replace('bi-chevron-up', 'bi-chevron-down');
        } else {
            filterControls.style.display = 'none';
            icon.classList.replace('bi-chevron-down', 'bi-chevron-up');
        }
        
        sessionStorage.setItem('aiTableFiltersVisible', filterControls.style.display !== 'none');
    }
}

// Função para inicializar o ordenamento da tabela
function initTableSorting() {
    document.querySelectorAll('th.sortable').forEach(header => {
        header.addEventListener('click', function() {
            const key = this.dataset.sortKey;
            if (key === sortKey) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortKey = key;
                sortDirection = 'asc';
            }
            
            sessionStorage.setItem('aiTableSortKey', sortKey);
            sessionStorage.setItem('aiTableSortDirection', sortDirection);
            
            updateDisplayedTable();
        });
    });
}

// Função para atualizar a tabela localmente (filtros, ordenação, paginação)
// Esta função NÃO faz requisições AJAX para o servidor
function updateDisplayedTable() {
    const tbody = document.querySelector('tbody');
    if (!tbody) return;
    
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    // Captura filtros
    const nameFilter = document.querySelector('#searchInput')?.value.toLowerCase() || '';
    const clientFilter = document.querySelector('#apiFilter')?.value || '';
    
    // Aplicar filtros
    filteredRows = rows.filter(row => {
        const nameElement = row.querySelector('th');
        const name = nameElement ? nameElement.textContent.toLowerCase() : '';
        const apiType = (row.dataset.apiType || '').trim();
        
        const nameMatch = name.includes(nameFilter);
        
        // Nova lógica para correspondência de cliente API
        let clientMatch = !clientFilter;
        if (clientFilter) {
            // Verificação mais flexível - verifica se o texto do filtro está contido no tipo da API
            clientMatch = apiType.toLowerCase().includes(clientFilter.toLowerCase());
        }
        
        return nameMatch && clientMatch;
    });
    
    // Ordenação
    sortTableRows();
    
    // Paginação
    const totalItems = filteredRows.length;
    
    // Atualiza contador total
    const totalCounter = document.getElementById('paginationTotal');
    if (totalCounter) totalCounter.textContent = totalItems;
    
    const totalPages = Math.max(1, Math.ceil(totalItems / itemsPerPage));
    
    if (currentPage > totalPages) {
        currentPage = totalPages;
    }
    
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = Math.min(startIndex + itemsPerPage, totalItems);
    
    // Atualiza contadores de páginação
    const fromCounter = document.getElementById('paginationFrom');
    const toCounter = document.getElementById('paginationTo');
    
    if (fromCounter) fromCounter.textContent = totalItems === 0 ? 0 : startIndex + 1;
    if (toCounter) toCounter.textContent = endIndex;
    
    // Ocultar/mostrar linhas com base na paginação
    rows.forEach(row => row.style.display = 'none');
    filteredRows.slice(startIndex, endIndex).forEach(row => row.style.display = '');
    
    // Atualizar controles de paginação
    updatePagination(totalPages);
    
    // Atualizar status do botão de limpar busca, se existir
    const clearSearchBtn = document.getElementById('clearSearchBtn');
    if (clearSearchBtn) {
        clearSearchBtn.disabled = nameFilter === '';
    }
}

// Função para ordenar a tabela
function sortTableRows() {
    const tbody = document.querySelector('tbody');
    if (!tbody) return;
    
    // Definir os índices de colunas para ordenação
    const columnIndexMap = {
        'name': 0,  // índice da coluna Nome (th)
        'client': 1, // índice da coluna Cliente IA (td)
        'model': 2   // índice da coluna Modelo (td)
    };
    
    filteredRows.sort((a, b) => {
        const index = columnIndexMap[sortKey] || 0;
        let aValue = '', bValue = '';
        
        if (index === 0) {
            // Primeira coluna é um th
            const aElement = a.querySelector('th');
            const bElement = b.querySelector('th');
            aValue = aElement ? aElement.textContent.trim().toLowerCase() : '';
            bValue = bElement ? bElement.textContent.trim().toLowerCase() : '';
        } else {
            // Outras colunas são td
            const aElements = a.querySelectorAll('td');
            const bElements = b.querySelectorAll('td');
            
            if (aElements.length > index - 1) {
                aValue = aElements[index - 1].textContent.trim().toLowerCase();
            }
            
            if (bElements.length > index - 1) {
                bValue = bElements[index - 1].textContent.trim().toLowerCase();
            }
        }
        
        // Ordenar strings
        if (sortDirection === 'asc') {
            return aValue.localeCompare(bValue);
        } else {
            return bValue.localeCompare(aValue);
        }
    });
    
    // Atualizar ícones de ordenação
    document.querySelectorAll('th.sortable').forEach(th => {
        const icon = th.querySelector('.sort-icon');
        if (!icon) return;
        
        const key = th.dataset.sortKey;
        
        th.classList.remove('active-sort');
        icon.classList.remove('bi-sort-alpha-down', 'bi-sort-alpha-up');
        
        if (key === sortKey) {
            icon.classList.add(sortDirection === 'asc' ? 'bi-sort-alpha-down' : 'bi-sort-alpha-up');
            th.classList.add('active-sort');
        } else {
            icon.classList.add('bi-sort-alpha-down');
        }
    });
    
    // Re-anexar linhas na ordem correta
    filteredRows.forEach(row => tbody.appendChild(row));
}

// Função para atualizar a paginação
function updatePagination(totalPages) {
    const pagination = document.getElementById('pagination');
    if (!pagination) return;
    
    const prevPageBtn = pagination.querySelector('li:first-child');
    const nextPageBtn = pagination.querySelector('li:last-child');
    
    // Atualizar estados de prev/next
    if (prevPageBtn) prevPageBtn.classList.toggle('disabled', currentPage <= 1);
    if (nextPageBtn) nextPageBtn.classList.toggle('disabled', currentPage >= totalPages);
    
    // Remover páginas existentes
    Array.from(pagination.querySelectorAll('li:not(:first-child):not(:last-child)')).forEach(li => li.remove());
    
    // Gerar links de página
    let pagesToShow = [];
    if (totalPages <= 5) {
        pagesToShow = Array.from({length: totalPages}, (_, i) => i + 1);
    } else {
        pagesToShow = [1];
        
        if (currentPage > 3) {
            pagesToShow.push('...');
        }
        
        for (let i = Math.max(2, currentPage - 1); i <= Math.min(totalPages - 1, currentPage + 1); i++) {
            pagesToShow.push(i);
        }
        
        if (currentPage < totalPages - 2) {
            pagesToShow.push('...');
        }
        
        if (totalPages > 1) {
            pagesToShow.push(totalPages);
        }
    }
    
    // Inserir links de página
    const nextPageElement = pagination.querySelector('li:last-child');
    if (nextPageElement) {
        pagesToShow.forEach(pageNum => {
            const li = document.createElement('li');
            
            if (pageNum === '...') {
                li.className = 'page-item disabled';
                li.innerHTML = '<span class="page-link">...</span>';
            } else {
                li.className = `page-item ${currentPage === pageNum ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" data-page="${pageNum}">${pageNum}</a>`;
                
                if (currentPage !== pageNum) {
                    li.querySelector('a').addEventListener('click', function(e) {
                        e.preventDefault();
                        currentPage = parseInt(this.dataset.page);
                        updateDisplayedTable();
                    });
                }
            }
            
            pagination.insertBefore(li, nextPageElement);
        });
    }
}

// Função para restaurar preferências do usuário
function restoreUserPreferences() {
    // Restaurar itens por página
    const savedItemsPerPage = sessionStorage.getItem('aiTableItemsPerPage');
    if (savedItemsPerPage) {
        itemsPerPage = parseInt(savedItemsPerPage);
        const itemsPerPageSelect = document.getElementById('itemsPerPage');
        if (itemsPerPageSelect && itemsPerPageSelect.querySelector(`option[value="${itemsPerPage}"]`)) {
            itemsPerPageSelect.value = savedItemsPerPage;
        }
    }
    
    // Restaurar ordenação
    const savedSortKey = sessionStorage.getItem('aiTableSortKey');
    const savedSortDirection = sessionStorage.getItem('aiTableSortDirection');
    
    if (savedSortKey && savedSortDirection) {
        sortKey = savedSortKey;
        sortDirection = savedSortDirection;
    }
}

// Função para restaurar o estado dos filtros
function restoreFiltersState() {
    const filtersVisible = sessionStorage.getItem('aiTableFiltersVisible');
    const filterControls = document.querySelector('#filterControls');
    const icon = document.querySelector('.toggle-filters i:last-child');
    
    if (filtersVisible === 'false' && filterControls && icon) {
        filterControls.style.display = 'none';
        icon.classList.replace('bi-chevron-down', 'bi-chevron-up');
    }
}

// Limpar busca
function clearSearch() {
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.value = '';
        currentPage = 1;
        updateDisplayedTable();
    }
}

// Adiciona debounce para evitar muitas requisições
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Função para confirmar exclusão
function confirmDelete(id, name) {
    aiIdToDelete = id;
    const nameElement = document.getElementById('aiNameToDelete');
    if (nameElement) nameElement.textContent = name;
    if (deleteModal) deleteModal.show();
}

// Corrigir função handleDeleteConfirm
function handleDeleteConfirm() {
    if (!aiIdToDelete) return;
    
    const url = buildUrl(`{% url 'ai_config:ai_delete' 9999999999 %}`,'9999999999', aiIdToDelete);
    
    // Obter referência ao botão
    const btnDelete = document.getElementById('confirmDelete');
    if (!btnDelete) return;
    
    // Mostrar indicador de carregamento no botão
    showButtonLoading(btnDelete, 'Excluindo...');
    
    ajaxAPI(url, 'POST', null, {
        showLoading: false
    })
    .then(response => {
        // Exibir mensagem usando o método da APIResponse e recarregar a página
        response.showMessage();
        window.location.reload();
    })
    .catch(error => {
        if (error instanceof APIResponse) {
            error.showMessage();
        } else {
            showMessage('error', 'Erro ao excluir IA');
        }
        hideButtonLoading(btnDelete);
    })
    .finally(() => {
        if (deleteModal) deleteModal.hide();
    });
}

// Função para abrir o modal de vinculação de tokens
function openLinkModal(aiId, aiName) {
    currentAiId = aiId;
    
    const nameElement = document.getElementById('aiNameForTokens');
    if (nameElement) nameElement.textContent = aiName;
    
    // Resetar o estado do modal
    const loadingEl = document.querySelector('.modal-loading');
    const errorEl = document.querySelector('.modal-error');
    const tokensContainer = document.querySelector('.tokens-container');
    const noTokensEl = document.querySelector('.no-tokens');
    
    if (loadingEl) loadingEl.classList.remove('d-none');
    if (errorEl) errorEl.classList.add('d-none');
    if (tokensContainer) tokensContainer.classList.add('d-none');
    if (noTokensEl) noTokensEl.classList.add('d-none');
    
    // Mostrar o modal
    if (linkTokenModal) linkTokenModal.show();
    
    // Carregar os tokens disponíveis
    loadTokensForAi(aiId);
}

// Corrigir função loadTokensForAi
async function loadTokensForAi(aiId) {
    try {
        const apiUrl = buildUrl(
            `{% url 'ai_config:ai_available_tokens' 9999999999 %}`,
            '9999999999',
            aiId
        );
        
        const response = await ajaxAPI(apiUrl, 'GET', null, {
            showLoading: false,
            showSuccess: false,
            showError: false
        });
        
        // Esconder o loading
        const loadingEl = document.querySelector('.modal-loading');
        if (loadingEl) loadingEl.classList.add('d-none');
        
        // Mostrar o container de tokens
        const tokensContainer = document.querySelector('.tokens-container');
        if (tokensContainer) tokensContainer.classList.remove('d-none');
        
        // Verificar se a resposta é bem-sucedida
        if (!response.isSuccess()) {
            throw new Error(response.getError()?.message || 'Falha ao carregar tokens');
        }
        
        // Processar a resposta
        const tokenList = document.querySelector('.token-list');
        const responseData = response.getData();
        
        console.log("Dados da resposta:", responseData);
        
        // Identificar a estrutura da resposta e extrair os tokens
        let tokens = [];
        
        // Caso 1: { tokens: [...] }
        if (responseData && responseData.tokens && Array.isArray(responseData.tokens)) {
            tokens = responseData.tokens;
        } 
        // Caso 2: [ { tokens: [...] } ]
        else if (Array.isArray(responseData) && responseData.length > 0 && responseData[0].tokens) {
            tokens = responseData[0].tokens;
        }
        // Caso 3: Array direto de tokens
        else if (Array.isArray(responseData)) {
            tokens = responseData;
        }
        
        if (tokenList) {
            if (tokens && tokens.length > 0) {
                let tokensHtml = '';
                tokens.forEach(token => {
                    tokensHtml += `
                    <div class="list-group-item d-flex align-items-center justify-content-between">
                        <div>
                            <h6 class="mb-0">${token.name || 'Token sem nome'}</h6>
                            <small class="text-muted">${token.id}</small>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input token-toggle" 
                                   type="checkbox" 
                                   id="token-${token.id}" 
                                   data-token-id="${token.id}" 
                                   data-ai-id="${aiId}"
                                   ${token.linked && token.enabled ? 'checked' : ''}>
                            <span class="status-badge ms-2 badge ${token.linked && token.enabled ? 'bg-success' : 'bg-secondary'}">
                                ${token.linked && token.enabled ? 'Ativo' : 'Inativo'}
                            </span>
                        </div>
                    </div>
                    `;
                });
                tokenList.innerHTML = tokensHtml;
                
                // Adicionar listeners aos switches
                document.querySelectorAll('.token-toggle').forEach(toggle => {
                    toggle.addEventListener('change', function() {
                        toggleTokenForAi(this.dataset.tokenId, this.dataset.aiId, this.checked);
                    });
                });
            } else {
                const noTokensEl = document.querySelector('.no-tokens');
                if (noTokensEl) noTokensEl.classList.remove('d-none');
                if (tokenList) tokenList.innerHTML = '';
            }
        }
    } catch (error) {
        console.error('Erro ao carregar tokens:', error);
        const loadingEl = document.querySelector('.modal-loading');
        const errorEl = document.querySelector('.modal-error');
        
        if (loadingEl) loadingEl.classList.add('d-none');
        if (errorEl) {
            errorEl.classList.remove('d-none');
            const errorMessage = errorEl.querySelector('p.mb-0');
            if (errorMessage) {
                errorMessage.textContent = error.message || 'Erro ao carregar tokens. Por favor, tente novamente.';
            }
        }
    }
}

// Função para ativar/desativar um token para uma IA usando ajaxAPI
async function toggleTokenForAi(tokenId, aiId, isEnabled) {
    // Encontrar elementos de UI
    const toggle = document.getElementById(`token-${tokenId}`);
    if (!toggle) return;
    
    const statusBadge = toggle.nextElementSibling;
    if (!statusBadge) return;
    
    // Desabilitar o switch durante o processamento
    toggle.disabled = true;
    const originalState = toggle.checked;
    statusBadge.innerHTML = `
        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
        Salvando...
    `;
    
    try {
        // Preparar dados no formato esperado pela API
        const payload = {};
        payload[tokenId] = {};
        payload[tokenId][aiId] = isEnabled;
        
        // Usar ajaxAPI em vez de fetch diretamente
        const response = await ajaxAPI("{% url 'ai_config:token_ai_toggle' %}", 'POST', payload, {
            showLoading: false,
            contentType: 'application/json',
            successMessage: `Token ${isEnabled ? 'ativado' : 'desativado'} com sucesso!`,
            errorMessage: 'Falha ao alterar estado do token'
        });
        
        // Restaurar o switch e atualizar a interface
        toggle.disabled = false;
        
        if (response.isSuccess()) {
            // Atualizar o badge de status
            statusBadge.className = isEnabled ? 'status-badge ms-2 badge bg-success' : 'status-badge ms-2 badge bg-secondary';
            statusBadge.textContent = isEnabled ? 'Ativo' : 'Inativo';
        } else {
            // Reverter o estado do switch em caso de erro
            toggle.checked = !isEnabled;
            statusBadge.className = !isEnabled ? 'status-badge ms-2 badge bg-success' : 'status-badge ms-2 badge bg-secondary';
            statusBadge.textContent = !isEnabled ? 'Ativo' : 'Inativo';
        }
    } catch (error) {
        console.error('Erro ao alterar estado do token:', error);
        toggle.disabled = false;
        toggle.checked = originalState; // Reverter para o estado original em caso de erro
        statusBadge.className = originalState ? 'status-badge ms-2 badge bg-success' : 'status-badge ms-2 badge bg-secondary';
        statusBadge.textContent = originalState ? 'Ativo' : 'Inativo';
    }
}

// Função para obter cookies (para CSRF)
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
