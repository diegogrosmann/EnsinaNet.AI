{% extends 'base.html' %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-12 col-lg-8">
            <div class="bs-component">
                <!-- Card Principal usando estrutura padrão do Bootswatch -->
                <div class="card border-primary mb-3">
                    <!-- Header do Card com estilo Bootswatch -->
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h2 class="card-title mb-0">
                            <i class="bi bi-robot me-2"></i> 
                            {{ title }}
                        </h2>
                        <a href="{% url 'ai_config:ai_manage' %}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> Voltar
                        </a>
                    </div>
                    
                    <!-- Corpo do Card -->
                    <div class="card-body">
                        <form method="post" class="needs-validation" id="aiConfigForm" novalidate>
                            {% csrf_token %}
                            <input type="hidden" name="next" value="{{ request.GET.next|default:'' }}">
                            
                            <fieldset>
                                <!-- Campos básicos organizados com classes Bootstrap -->
                                <div class="row g-3">
                                    <!-- Nome da IA -->
                                    <div class="col-12">
                                        <div class="form-group">
                                            <label class="form-label" for="{{ form.name.id_for_label }}">
                                                <i class="bi bi-tag me-1"></i> Nome da IA
                                            </label>
                                            {{ form.name }}
                                            {% if form.name.errors %}
                                                <div class="invalid-feedback d-block">{{ form.name.errors|join:", " }}</div>
                                            {% else %}
                                                <small class="form-text text-muted">{{ form.name.help_text }}</small>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <!-- Cliente IA -->
                                    <div class="col-12">
                                        <div class="form-group">
                                            <label class="form-label" for="{{ form.ai_client.id_for_label }}">
                                                <i class="bi bi-cpu me-1"></i> Cliente IA
                                            </label>
                                            {{ form.ai_client }}
                                            {% if form.ai_client.errors %}
                                                <div class="invalid-feedback d-block">{{ form.ai_client.errors|join:", " }}</div>
                                            {% else %}
                                                <small class="form-text text-muted">{{ form.ai_client.help_text }}</small>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <!-- Nome do Modelo -->
                                    <div class="col-12">
                                        <div class="form-group">
                                            <label class="form-label" for="{{ form.model_name.id_for_label }}">
                                                <i class="bi bi-box me-1"></i> Nome do Modelo
                                            </label>
                                            <div class="input-group">
                                                {{ form.model_name }}
                                                <button class="btn btn-outline-secondary dropdown-toggle" type="button" 
                                                        id="modelDropdownButton" data-bs-toggle="dropdown" 
                                                        aria-expanded="false" disabled>
                                                    Selecionar
                                                </button>
                                                <ul class="dropdown-menu dropdown-menu-end w-100" id="modelsList">
                                                    <li>
                                                        <h6 class="dropdown-header">Selecione um Cliente IA primeiro</h6>
                                                    </li>
                                                </ul>
                                            </div>
                                            <div id="modelLoadingIndicator" class="d-none">
                                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                                    <span class="visually-hidden">Carregando...</span>
                                                </div>
                                                <small class="text-muted ms-2">Carregando modelos...</small>
                                            </div>
                                            {% if form.model_name.errors %}
                                                <div class="invalid-feedback d-block">{{ form.model_name.errors|join:", " }}</div>
                                            {% else %}
                                                <small class="form-text text-muted">{{ form.model_name.help_text }}</small>
                                                <small class="form-text text-muted d-block">
                                                    Você pode selecionar um modelo da lista ou digitar manualmente o nome.
                                                </small>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <!-- Usar Mensagem do Sistema -->
                                    <div class="col-12">
                                        <div class="form-check">
                                            {{ form.use_system_message }}
                                            <label class="form-check-label" for="{{ form.use_system_message.id_for_label }}">
                                                <i class="bi bi-chat-left-text me-1"></i> Usar Mensagem do Sistema
                                            </label>
                                        </div>
                                        {% if form.use_system_message.errors %}
                                            <div class="invalid-feedback d-block">{{ form.use_system_message.errors|join:", " }}</div>
                                        {% else %}
                                            <small class="form-text text-muted">{{ form.use_system_message.help_text }}</small>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- Configurações Avançadas usando Bootswatch Accordion -->
                                <div class="mt-4">
                                    <div class="accordion" id="configAccordion">
                                        <!-- Configurações da API -->
                                        <div class="accordion-item">
                                            <h2 class="accordion-header" id="configHeading">
                                                <button class="accordion-button {% if not form.configurations.errors %}collapsed{% endif %}" 
                                                        type="button" 
                                                        data-bs-toggle="collapse" 
                                                        data-bs-target="#configCollapse" 
                                                        aria-expanded="{% if form.configurations.errors %}true{% else %}false{% endif %}" 
                                                        aria-controls="configCollapse">
                                                    <i class="bi bi-gear me-2"></i> Configurações da API
                                                </button>
                                            </h2>
                                            <div id="configCollapse" 
                                                 class="accordion-collapse collapse {% if form.configurations.errors %}show{% endif %}" 
                                                 aria-labelledby="configHeading" 
                                                 data-bs-parent="#configAccordion">
                                                <div class="accordion-body">
                                                    <div class="form-group">
                                                        <label class="form-label" for="{{ form.configurations.id_for_label }}">
                                                            Parâmetros da API
                                                        </label>
                                                        {% with config_value=form.configurations.value %}
                                                            <textarea name="{{ form.configurations.name }}" 
                                                                      id="{{ form.configurations.id_for_label }}"
                                                                      class="form-control {% if form.configurations.errors %}is-invalid{% endif %}" 
                                                                      rows="5" 
                                                                      placeholder="{{ form.configurations.field.widget.attrs.placeholder }}">{% if config_value != '{}' and config_value != None %}{{ config_value }}{% endif %}</textarea>
                                                        {% endwith %}
                                                        
                                                        {% if form.configurations.errors %}
                                                            <div class="invalid-feedback d-block">
                                                                {% for error in form.configurations.errors %}
                                                                    {{ error }}
                                                                {% endfor %}
                                                            </div>
                                                        {% endif %}
                                                        
                                                        <div class="form-text">
                                                            Configure parâmetros da API no formato chave=valor (um por linha)
                                                            <br>Exemplo:<br>
                                                            <code>temperature=0.7</code><br>
                                                            <code>max_tokens=2000</code>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Configurações de Treinamento -->
                                        <div class="accordion-item">
                                            <h2 class="accordion-header" id="trainingHeading">
                                                <button class="accordion-button {% if not form.training_configurations.errors %}collapsed{% endif %}" 
                                                        type="button" 
                                                        data-bs-toggle="collapse" 
                                                        data-bs-target="#trainingCollapse" 
                                                        aria-expanded="{% if form.training_configurations.errors %}true{% else %}false{% endif %}" 
                                                        aria-controls="trainingCollapse">
                                                    <i class="bi bi-book me-2"></i> Configurações de Treinamento
                                                </button>
                                            </h2>
                                            <div id="trainingCollapse" 
                                                 class="accordion-collapse collapse {% if form.training_configurations.errors %}show{% endif %}" 
                                                 aria-labelledby="trainingHeading" 
                                                 data-bs-parent="#configAccordion">
                                                <div class="accordion-body">
                                                    <div class="form-group">
                                                        <label class="form-label" for="{{ form.training_configurations.id_for_label }}">
                                                            Parâmetros de Treinamento
                                                        </label>
                                                        {% with train_value=form.training_configurations.value %}
                                                            <textarea name="{{ form.training_configurations.name }}" 
                                                                      id="{{ form.training_configurations.id_for_label }}"
                                                                      class="form-control {% if form.training_configurations.errors %}is-invalid{% endif %}" 
                                                                      rows="5" 
                                                                      placeholder="{{ form.training_configurations.field.widget.attrs.placeholder }}">{% if train_value != '{}' and train_value != None %}{{ train_value }}{% endif %}</textarea>
                                                        {% endwith %}
                                                        
                                                        {% if form.training_configurations.errors %}
                                                            <div class="invalid-feedback d-block">
                                                                {% for error in form.training_configurations.errors %}
                                                                    {{ error }}
                                                                {% endfor %}
                                                            </div>
                                                        {% endif %}
                                                        
                                                        <div class="form-text">
                                                            Configure parâmetros de treinamento no formato chave=valor (um por linha)
                                                            <br>Exemplo:<br>
                                                            <code>epochs=10</code><br>
                                                            <code>batch_size=4</code><br>
                                                            <code>learning_rate=0.001</code>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Botões de Ação -->
                                <div class="mt-4 d-grid gap-2">
                                    <button type="submit" class="btn btn-primary btn-lg">
                                        <i class="bi bi-save me-1"></i> {{ submit_text }}
                                    </button>
                                    
                                    {% if is_edit %}
                                        <div class="text-center mt-2">
                                            <small class="text-muted">
                                                <i class="bi bi-info-circle me-1"></i> 
                                                Você pode usar <kbd>Ctrl</kbd>+<kbd>S</kbd> ou <kbd>⌘</kbd>+<kbd>S</kbd> para salvar rapidamente.
                                            </small>
                                        </div>
                                    {% endif %}
                                </div>
                            </fieldset>
                        </form>
                    </div>
                    
                    <!-- Rodapé do Card (opcional) -->
                    {% if is_edit %}
                    <div class="card-footer text-muted">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>Última atualização: {{ ai_config.modified_at|date:"d/m/Y H:i" }}</span>
                            <span>Criado em: {{ ai_config.created_at|date:"d/m/Y" }}</span>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Atalho para salvar formulário com Ctrl+S ou Cmd+S
document.addEventListener('keydown', function(e) {
    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        // Resetar a flag antes de submeter o formulário
        window.hasUnsavedChanges = false;
        document.querySelector('form').submit();
    }
});

// Inicialização Bootstrap e detecção de mudanças
document.addEventListener('DOMContentLoaded', function() {
    // Ative os tooltips do Bootstrap
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function(tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Adicione estilo para a barra de rolagem no dropdown de modelos e no select de cliente IA
    const style = document.createElement('style');
    style.textContent = `
        #modelsList {
            max-height: 300px;
            overflow-y: auto;
        }
        
        #{{ form.ai_client.id_for_label }} {
            max-height: 200px;
            overflow-y: auto;
        }
    `;
    document.head.appendChild(style);
    
    // Detecção de mudanças não salvas
    const form = document.getElementById('aiConfigForm');
    
    // Inicialmente, não há mudanças não salvas
    window.hasUnsavedChanges = false;
    
    // Função para marcar que há alterações não salvas
    function markAsChanged() {
        window.hasUnsavedChanges = true;
    }
    
    // Adicionar listeners a todos os inputs, selects e textareas
    form.querySelectorAll('input, select, textarea').forEach(element => {
        element.addEventListener('change', markAsChanged);
        
        // Para os campos de texto, também detectar digitação
        if (element.tagName === 'INPUT' && element.type === 'text' || 
            element.tagName === 'TEXTAREA') {
            element.addEventListener('input', markAsChanged);
        }
    });
    
    // Quando o formulário for enviado, adicionar função para verificar a resposta
    form.addEventListener('submit', function(originalEvent) {
        originalEvent.preventDefault();
        
        // Resetar a flag de mudanças não salvas
        window.hasUnsavedChanges = false;
        
        document.querySelector('form').submit();

        // Prevenir envio normal do formulário
        return false;
    });
    
    // Implementação para carregamento dinâmico de modelos
    const aiClientSelect = document.getElementById('{{ form.ai_client.id_for_label }}');
    const modelNameInput = document.getElementById('{{ form.model_name.id_for_label }}');
    const modelDropdownButton = document.getElementById('modelDropdownButton');
    const modelsList = document.getElementById('modelsList');
    const loadingIndicator = document.getElementById('modelLoadingIndicator');
    
    // Função para carregar os modelos disponíveis
    function loadAvailableModels(clientId) {
        if (!clientId) {
            modelDropdownButton.disabled = true;
            modelsList.innerHTML = '<li><h6 class="dropdown-header">Selecione um Cliente IA primeiro</h6></li>';
            return;
        }
        
        // Mostrar indicador de carregamento
        loadingIndicator.classList.remove('d-none');
        modelDropdownButton.disabled = true;
        
        // Armazenar o valor atual do modelo antes de limpar
        const currentModelValue = modelNameInput.value;
        const isEditMode = {{ is_edit|yesno:"true,false" }};
        
        // Limpar o campo de nome do modelo apenas se não estivermos em modo de edição
        // ou se o cliente IA for alterado
        if (!isEditMode) {
            modelNameInput.value = '';
        }
        
        // Fazer a requisição AJAX
        fetch(`{% url 'ai_config:ai_manage' %}client/${clientId}/models/`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            // Esconder indicador de carregamento
            loadingIndicator.classList.add('d-none');
            
            if (data.success) {
                // Limpar lista atual
                modelsList.innerHTML = '';
                
                // Verificar se temos modelos para mostrar
                const baseModels = data.models.base || [];
                const trainedModels = data.models.trained || [];
                
                if (baseModels.length === 0 && trainedModels.length === 0) {
                    modelsList.innerHTML = '<li><h6 class="dropdown-header">Nenhum modelo disponível</h6></li>';
                    modelDropdownButton.disabled = true;
                    
                    // Restaurar o valor original se estamos em modo de edição
                    if (isEditMode && currentModelValue) {
                        modelNameInput.value = currentModelValue;
                    }
                    return;
                }
                
                // Habilitar o botão dropdown
                modelDropdownButton.disabled = false;
                
                // Adicionar modelos base
                if (baseModels.length > 0) {
                    modelsList.innerHTML += '<li><h6 class="dropdown-header">Modelos Base</h6></li>';
                    baseModels.forEach(model => {
                        const item = document.createElement('li');
                        const link = document.createElement('a');
                        link.className = 'dropdown-item';
                        link.href = '#';
                        link.textContent = model.name;
                        
                        // Destacar o modelo selecionado se estamos em modo de edição
                        if (isEditMode && (model.id === currentModelValue || model.name === currentModelValue)) {
                            link.className += ' active';
                        }
                        
                        link.onclick = function(e) {
                            e.preventDefault();
                            modelNameInput.value = model.id;
                            markAsChanged();
                        };
                        item.appendChild(link);
                        modelsList.appendChild(item);
                    });
                }
                
                // Adicionar divisor se tivermos ambos os tipos
                if (baseModels.length > 0 && trainedModels.length > 0) {
                    const divider = document.createElement('li');
                    divider.innerHTML = '<hr class="dropdown-divider">';
                    modelsList.appendChild(divider);
                }
                
                // Adicionar modelos treinados do usuário
                if (trainedModels.length > 0) {
                    modelsList.innerHTML += '<li><h6 class="dropdown-header">Seus Modelos Treinados</h6></li>';
                    trainedModels.forEach(model => {
                        const item = document.createElement('li');
                        const link = document.createElement('a');
                        link.className = 'dropdown-item';
                        link.href = '#';
                        link.textContent = model.name;
                        link.onclick = function(e) {
                            e.preventDefault();
                            modelNameInput.value = model.id;
                            markAsChanged();
                        };
                        item.appendChild(link);
                        modelsList.appendChild(item);
                    });
                }
                
                // Adicionar opção para entrada manual
                const divider = document.createElement('li');
                divider.innerHTML = '<hr class="dropdown-divider">';
                modelsList.appendChild(divider);
                
                const manualItem = document.createElement('li');
                manualItem.innerHTML = '<span class="dropdown-item-text text-muted small">Não encontrou o modelo? Digite manualmente no campo acima.</span>';
                modelsList.appendChild(manualItem);
                
            } else {
                // Em caso de erro
                modelDropdownButton.disabled = true;
                modelsList.innerHTML = `<li><h6 class="dropdown-header text-danger">Erro ao carregar modelos</h6></li>
                                      <li><span class="dropdown-item-text">${data.error || 'Tente novamente ou digite o modelo manualmente'}</span></li>`;
                
                // Restaurar o valor original se estamos em modo de edição
                if (isEditMode && currentModelValue) {
                    modelNameInput.value = currentModelValue;
                }
            }
        })
        .catch(error => {
            // Esconder indicador de carregamento
            loadingIndicator.classList.add('d-none');
            modelDropdownButton.disabled = true;
            modelsList.innerHTML = '<li><h6 class="dropdown-header text-danger">Erro ao carregar modelos</h6></li>' +
                                  '<li><span class="dropdown-item-text">Tente novamente ou digite o modelo manualmente</span></li>';
            console.error('Erro ao carregar modelos:', error);
            
            // Restaurar o valor original se estamos em modo de edição
            if (isEditMode && currentModelValue) {
                modelNameInput.value = currentModelValue;
            }
        });
    }
    
    // Event listener para mudança na seleção de cliente IA
    aiClientSelect.addEventListener('change', function() {
        const clientId = this.value;
        loadAvailableModels(clientId);
    });
    
    // Carrega os modelos se um cliente já estiver selecionado
    if (aiClientSelect.value) {
        loadAvailableModels(aiClientSelect.value);
    }
});

// Obter cookie CSRF
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
