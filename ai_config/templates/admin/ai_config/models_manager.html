{% extends "admin/base_site.html" %}
{% load i18n admin_urls static admin_list %}

{% block content %}
<div id="content-main">
    
    <div class="module">
        <form method="get" class="mb-3">
            <select name="ai_config" class="form-select" onchange="this.form.submit()">
                <option value="">Selecione uma IA</option>
                {% for config in global_configs %}
                <option value="{{ config.id }}" {% if selected_config == config.id|stringformat:"s" %}selected{% endif %}>
                    {{ config.name }}
                </option>
                {% endfor %}
            </select>
        </form>

        {% if models %}
        <form id="models-form">
            <div class="actions">
                <button type="button" class="button" onclick="deleteSelected()">Excluir Selecionados</button>
            </div>
            
            <table id="result_list">
                <thead>
                    <tr>
                        <th><input type="checkbox" id="select-all"></th>
                        <th>Nome/ID</th>
                        <th>Data de Criação</th>
                    </tr>
                </thead>
                <tbody>
                    {% for model in models %}
                    <tr>
                        <td><input type="checkbox" name="selected_models" value="{{ model.name }}"></td>
                        <td>{{ model.name }}</td>
                        <td>{{ model.created_at|date:"d/m/Y H:i" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </form>
        {% elif selected_config %}
        <p>Nenhum modelo encontrado.</p>
        {% endif %}
    </div>
</div>

<script>
document.getElementById('select-all').onclick = function() {
    var checkboxes = document.getElementsByName('selected_models');
    for (var checkbox of checkboxes) {
        checkbox.checked = this.checked;
    }
};

function deleteSelected() {
    var selected = Array.from(document.getElementsByName('selected_models'))
        .filter(cb => cb.checked)
        .map(cb => cb.value);
    
    if (selected.length === 0) {
        alert('Selecione pelo menos um modelo');
        return;
    }
    
    if (!confirm('Tem certeza que deseja excluir os modelos selecionados?')) {
        return;
    }
    
    // Adiciona indicador de carregamento
    const deleteButton = document.querySelector('button[onclick="deleteSelected()"]');
    const originalText = deleteButton.innerHTML;
    deleteButton.disabled = true;
    deleteButton.innerHTML = '<span class="loading-spinner"></span> Excluindo...';
    
    const formData = new FormData();
    formData.append('ai_config', '{{ selected_config }}');
    selected.forEach(modelName => {
        formData.append('model_names[]', modelName);
    });
    
    fetch('{% url "admin:delete_trained_models" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (data.errors.length > 0) {
                alert(`Excluídos: ${data.deleted}\nErros: ${data.errors.join('\n')}`);
            } else {
                alert(`${data.deleted} modelo(s) excluído(s) com sucesso`);
            }
            location.reload();
        } else {
            alert(data.error || 'Erro ao excluir modelos');
            // Restaura o botão em caso de erro
            deleteButton.disabled = false;
            deleteButton.innerHTML = originalText;
        }
    })
    .catch(error => {
        alert('Erro ao excluir modelos');
        // Restaura o botão em caso de erro
        deleteButton.disabled = false;
        deleteButton.innerHTML = originalText;
    });
}
</script>

<style>
.loading-spinner {
    display: inline-block;
    width: 1em;
    height: 1em;
    border: 2px solid rgba(255,255,255,.3);
    border-radius: 50%;
    border-top-color: #fff;
    animation: spin 1s ease-in-out infinite;
    margin-right: 8px;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}
</style>
{% endblock %}
