{% extends 'base.html' %}

{% block content %}
<div class="container py-4">
    <div class="bs-docs-section">
        <!-- Cabeçalho usando padrão Bootswatch -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="page-header d-flex justify-content-between align-items-center">
                    <h1 class="mb-0">
                        <i class="bi bi-robot"></i> Central de Treinamento
                    </h1>
                    {% if active_capture %}
                        <button id="stopCapture" class="btn btn-danger">
                            <i class="bi bi-stop-circle"></i> Parar Captura
                        </button>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Status cards -->
        <div class="row mb-4 g-3">
            <div class="col-md-4">
                <div class="card border-primary h-100">
                    <div class="card-header">Treinamentos em Fila</div>
                    <div class="card-body">
                        <h2 class="card-title" id="queuedCount">-</h2>
                        <p class="card-text"><i class="bi bi-list-check"></i> Aguardando processamento</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-success h-100">
                    <div class="card-header">Treinamentos Concluídos</div>
                    <div class="card-body">
                        <h2 class="card-title" id="completedCount">-</h2>
                        <p class="card-text"><i class="bi bi-check-circle"></i> Finalizados com sucesso</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-info h-100">
                    <div class="card-header">Em Processamento</div>
                    <div class="card-body">
                        <h2 class="card-title" id="processingCount">-</h2>
                        <p class="card-text"><i class="bi bi-gear-wide-connected"></i> Atualmente em execução</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Arquivos de Treinamento -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-primary">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4 class="card-title mb-0">
                            <i class="bi bi-file-earmark-text"></i> Arquivos de Treinamento
                        </h4>
                        <div class="btn-group">
                            <a href="{% url 'ai_config:training_file_create' %}" 
                               class="btn btn-success">
                                <i class="bi bi-file-earmark-plus"></i>
                                <span class="d-none d-sm-inline">Criar</span>
                            </a>
                            <button class="btn btn-primary" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#uploadModal">
                                <i class="bi bi-upload"></i>
                                <span class="d-none d-sm-inline">Upload</span>
                            </button>
                        </div>
                    </div>

                    <!-- Corpo do Card -->
                    <div class="card-body">
                        {% if training_files %}
                        <div class="mb-3">
                            <!-- Filtros e Controles com componentes Bootswatch -->
                            <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3 gap-2">
                                <!-- Controles à esquerda -->
                                <div class="d-flex align-items-center mb-2 mb-md-0 flex-wrap gap-2">
                                    <button class="btn btn-sm btn-outline-primary toggle-filters" type="button" aria-expanded="true" aria-controls="filterControlsFiles">
                                        <i class="bi bi-funnel me-1"></i>Filtros
                                        <i class="bi bi-chevron-down ms-1"></i>
                                    </button>
                                    
                                    <!-- Informação de paginação -->
                                    <div class="text-muted d-none d-sm-block">
                                        Mostrando <span id="paginationFromFiles">1</span> a <span id="paginationToFiles">10</span> de <span id="paginationTotalFiles">{{ training_files|length }}</span>
                                    </div>
                                </div>
                                
                                <!-- Controles à direita -->
                                <div class="input-group input-group-sm" style="width: auto; min-width: 120px; max-width: 250px;">
                                    <span class="input-group-text">Por página</span>
                                    <select id="itemsPerPageFiles" class="form-select form-select-sm" style="min-width: 70px;">
                                        <option value="5">5</option>
                                        <option value="10" selected>10</option>
                                        <option value="25">25</option>
                                        <option value="50">50</option>
                                        <option value="100">100</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Filtros Expandidos -->
                            <div class="card bg-light mb-3" id="filterControlsFiles">
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-12 col-md-6">
                                            <label for="filterNameFiles" class="form-label">Nome do Arquivo</label>
                                            <input type="text" id="filterNameFiles" class="form-control form-control-sm filter-files" placeholder="Filtrar por nome...">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Tabela Responsiva no estilo Bootswatch -->
                            <div class="table-responsive" id="tableContainer">
                                <table class="table table-hover" id="trainingFiles">
                                    <thead>
                                        <tr>
                                            <th scope="col" class="sortable" data-sort-key="name">
                                                Nome do Arquivo
                                                <i class="sort-icon bi bi-sort-alpha-down"></i>
                                            </th>
                                            <th scope="col" class="sortable" data-sort-key="uploaded_at">
                                                Data de Upload
                                                <i class="sort-icon bi bi-sort-alpha-down"></i>
                                            </th>
                                            <th scope="col" class="sortable" data-sort-key="file_size">
                                                Tamanho
                                                <i class="sort-icon bi bi-sort-numeric-down"></i>
                                            </th>
                                            <th scope="col" class="text-end">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="trainingFilesBody">
                                        {% if training_files %}
                                            {% for file in training_files %}
                                            <tr>
                                                <td data-value="{{ file.name|lower }}">
                                                    <a href="{% url 'ai_config:training_file_edit' file.id %}" class="text-decoration-none fw-bold">
                                                        {{ file.name }}
                                                    </a>
                                                </td>
                                                <td data-value="{{ file.uploaded_at|date:'Y-m-d H:i:s' }}">
                                                    <small class="text-muted">
                                                        <i class="bi bi-calendar3"></i> {{ file.uploaded_at|date:"d/m/Y H:i" }}
                                                    </small>
                                                </td>
                                                <td data-value="{{ file.file_size|default:0 }}" class="file-size">
                                                    {% if file.file_size and file.file_size > 0 %}
                                                        <span class="text-nowrap">{{ file.file_size|filesizeformat }}</span>
                                                        {% if file.example_count %}
                                                        <br>
                                                        <small class="text-muted">{{ file.example_count }} exemplo{{ file.example_count|pluralize }}</small>
                                                        {% endif %}
                                                    {% else %}
                                                        <span class="text-danger">Vazio</span>
                                                        <br>
                                                        <small class="text-danger">Sem exemplos</small>
                                                    {% endif %}
                                                </td>
                                                <td class="text-end">
                                                    <div class="btn-group">
                                                        <button class="btn btn-sm btn-primary" 
                                                                onclick="downloadFile({{ file.id }})"
                                                                title="Download">
                                                            <i class="bi bi-download"></i>
                                                        </button>
                                                        <button class="btn btn-sm btn-success" 
                                                                onclick="startTraining({{ file.id }})"
                                                                {% if file.file_size == 0 or file.file_size == None %}
                                                                disabled 
                                                                title="Arquivo sem exemplos não pode ser usado para treinamento"
                                                                {% elif file.example_count == 0 %}
                                                                disabled 
                                                                title="Arquivo sem exemplos não pode ser usado para treinamento"
                                                                {% else %}
                                                                title="Iniciar Treinamento"
                                                                {% endif %}>
                                                            <i class="bi bi-play-circle"></i>
                                                        </button>
                                                        <button class="btn btn-sm btn-danger" 
                                                                onclick="openDeleteFileModal('{{ file.id }}', '{{ file.name }}')"
                                                                title="Excluir">
                                                            <i class="bi bi-trash"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        {% else %}
                                            <tr>
                                                <td colspan="4" class="text-center py-4">
                                                    <i class="bi bi-file-earmark-x fs-2 text-muted"></i>
                                                    <p class="mt-2 mb-0 text-muted">Nenhum arquivo encontrado</p>
                                                </td>
                                            </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Paginação no estilo Bootswatch -->
                            <nav aria-label="Paginação da tabela de arquivos" class="mt-3">
                                <ul class="pagination pagination-sm justify-content-center" id="paginationFiles">
                                    <li class="page-item disabled">
                                        <a class="page-link" href="#" id="prevPageFiles" aria-label="Página anterior">
                                            <span aria-hidden="true">&laquo;</span>
                                        </a>
                                    </li>
                                    <!-- Páginas serão inseridas aqui via JavaScript -->
                                    <li class="page-item">
                                        <a class="page-link" href="#" id="nextPageFiles" aria-label="Próxima página">
                                            <span aria-hidden="true">&raquo;</span>
                                        </a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                        {% else %}
                        <!-- Feedback quando não há arquivos usando alerta do Bootswatch -->
                        <div class="alert alert-info" role="alert">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-info-circle-fill me-2"></i>
                                <div>
                                    <h5 class="alert-heading mb-1">Nenhum arquivo</h5>
                                    <p class="mb-0">Não há arquivos de treinamento disponíveis. Clique em "Criar" ou "Upload" para adicionar arquivos.</p>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Status dos Treinamentos -->
        <div class="row">
            <div class="col-12">
                <div class="card border-primary">
                    <div class="card-header">
                        <h4 class="card-title mb-0">
                            <i class="bi bi-activity"></i> Status dos Treinamentos
                        </h4>
                    </div>

                    <!-- Corpo do Card -->
                    <div class="card-body">
                        <div class="mb-3">
                            <!-- Filtros e Controles com componentes Bootswatch -->
                            <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3 gap-2">
                                <!-- Controles à esquerda -->
                                <div class="d-flex align-items-center mb-2 mb-md-0 flex-wrap gap-2">
                                    <button class="btn btn-sm btn-outline-primary toggle-filters-status" type="button" aria-expanded="true" aria-controls="filterControlsStatus">
                                        <i class="bi bi-funnel me-1"></i>Filtros
                                        <i class="bi bi-chevron-down ms-1"></i>
                                    </button>
                                    
                                    <!-- Informação de paginação -->
                                    <div class="text-muted d-none d-sm-block">
                                        Mostrando <span id="paginationFromStatus">1</span> a <span id="paginationToStatus">10</span> de <span id="paginationTotalStatus">0</span>
                                    </div>
                                </div>
                                
                                <!-- Controles à direita -->
                                <div class="input-group input-group-sm" style="width: auto; min-width: 120px; max-width: 250px;">
                                    <span class="input-group-text">Por página</span>
                                    <select id="itemsPerPageStatus" class="form-select form-select-sm" style="min-width: 70px;">
                                        <option value="5">5</option>
                                        <option value="10" selected>10</option>
                                        <option value="25">25</option>
                                        <option value="50">50</option>
                                        <option value="100">100</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Filtros Expandidos -->
                            <div class="card bg-light mb-3" id="filterControlsStatus">
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-12 col-md-6">
                                            <label for="filterNameStatus" class="form-label">Nome da IA</label>
                                            <input type="text" id="filterNameStatus" class="form-control form-control-sm filter-status" placeholder="Filtrar por nome...">
                                        </div>
                                        <div class="col-12 col-md-6">
                                            <label for="filterStatusStatus" class="form-label">Status</label>
                                            <select id="filterStatusStatus" class="form-select form-select-sm filter-status">
                                                <option value="">Todos</option>
                                                <option value="not_started">Não Iniciado</option>
                                                <option value="in_progress">Em Andamento</option>
                                                <option value="completed">Concluído</option>
                                                <option value="failed">Falhou</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Tabela Responsiva no estilo Bootswatch -->
                            <div class="table-responsive">
                                <table class="table table-hover" id="trainingStatusTable">
                                    <thead>
                                        <tr>
                                            <th scope="col" class="sortable" data-sort-key="ai_name">
                                                IA
                                                <i class="sort-icon bi bi-sort-alpha-down"></i>
                                            </th>
                                            <th scope="col" class="sortable" data-sort-key="status">
                                                Status
                                                <i class="sort-icon bi bi-sort-alpha-down"></i>
                                            </th>
                                            <th scope="col" class="sortable" data-sort-key="model_name">
                                                Modelo
                                                <i class="sort-icon bi bi-sort-alpha-down"></i>
                                            </th>
                                            <th scope="col" class="text-end">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="trainingStatusBody">
                                        <!-- Preenchido dinamicamente via JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Paginação no estilo Bootswatch -->
                            <nav aria-label="Paginação da tabela de status" class="mt-3">
                                <ul class="pagination pagination-sm justify-content-center" id="paginationStatus">
                                    <li class="page-item disabled">
                                        <a class="page-link" href="#" id="prevPageStatus" aria-label="Página anterior">
                                            <span aria-hidden="true">&laquo;</span>
                                        </a>
                                    </li>
                                    <!-- Páginas serão inseridas aqui via JavaScript -->
                                    <li class="page-item">
                                        <a class="page-link" href="#" id="nextPageStatus" aria-label="Próxima página">
                                            <span aria-hidden="true">&raquo;</span>
                                        </a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Upload -->
<div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Upload de Arquivo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="uploadForm" data-no-loader data-ajax="true">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">Nome do Arquivo</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Arquivo de Treinamento</label>
                        <input type="file" class="form-control" name="file" accept=".json,.jsonl" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100" id="uploadButton">
                        <span class="normal-state">
                            <i class="bi bi-upload"></i> Enviar
                        </span>
                        <span class="loading-state d-none">
                            <span class="spinner-border spinner-border-sm"></span> Enviando...
                        </span>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Configuração de Treinamento -->
<div class="modal fade" id="trainingModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Configurar Treinamento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="trainingForm" data-no-loader data-ajax="true">
                    {% csrf_token %}

                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="bi bi-funnel"></i> Filtro por API</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Tipo de API</label>
                                <select class="form-select" id="apiClientFilter">
                                    <option value="">Todas as APIs</option>
                                    {% for client_type in api_client_types %}
                                        <option value="{{ client_type }}">{{ client_type }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-robot"></i> IAs Disponíveis para Treinamento</span>
                            <small class="text-muted" id="aiCount">0 selecionadas</small>
                        </label>
                        <div class="list-group" id="aiList">
                            {% for ai in trainable_ais %}
                                <div class="list-group-item ai-item" 
                                     data-api-type="{{ ai.config.ai_client.api_client_class }}">
                                    <div class="form-check d-flex justify-content-between align-items-start">
                                        <div>
                                            <input class="form-check-input" type="checkbox" 
                                                   name="selected_ais" 
                                                   value="{{ ai.config.id }}"
                                                   id="ai_{{ ai.config.id }}">
                                            <label class="form-check-label" for="ai_{{ ai.config.id }}">
                                                {{ ai.config.name }}
                                                <small class="d-block text-muted">
                                                    Tipo: {{ ai.config.ai_client.api_client_class }}
                                                    {% if ai.config.model_name %}
                                                    | Modelo: <span class="badge bg-info text-dark">{{ ai.config.model_name }}</span>
                                                    {% endif %}
                                                </small>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>

                    <input type="hidden" name="file_id" id="selectedFileId">
                    <button type="submit" class="btn btn-success w-100" id="startTrainingBtn">
                        <span class="normal-state">
                            <i class="bi bi-play-circle"></i> Iniciar Treinamento
                        </span>
                        <span class="loading-state d-none">
                            <span class="spinner-border spinner-border-sm" role="status"></span>
                            Iniciando...
                        </span>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal Unificado de Delete -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteModalLabel">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Confirmar Exclusão
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja excluir <span id="deleteItemType"></span> "<span id="deleteItemName" class="fw-bold"></span>"?</p>
                <p class="text-muted small">Esta ação não pode ser desfeita.</p>
                <input type="hidden" id="deleteItemId">
                <input type="hidden" id="deleteItemAction">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">
                    <span class="normal-state">
                        <i class="bi bi-trash me-1"></i> Excluir
                    </span>
                    <span class="loading-state d-none">
                        <span class="spinner-border spinner-border-sm"></span> Excluindo...
                    </span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Erro -->
<div class="modal fade" id="errorModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalhes do Erro</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <pre class="error-details"></pre>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmação de Cancelamento -->
<div class="modal fade" id="cancelTrainingModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Cancelamento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja cancelar o treinamento do modelo <strong id="cancelModelName"></strong>?</p>
                <p class="text-danger">Esta ação não pode ser desfeita.</p>
                <input type="hidden" id="cancelTrainingId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Não</button>
                <button type="button" class="btn btn-danger" id="confirmCancel">
                    <span class="normal-state">
                        <i class="bi bi-x-circle"></i> Cancelar
                    </span>
                    <span class="loading-state d-none">
                        <span class="spinner-border spinner-border-sm"></span> Cancelando...
                    </span>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // ---------------------------------------------------------
    // 1) GERENCIAMENTO DE ARQUIVOS (FILTRO/PAGINAÇÃO/ORDENAÇÃO)
    // ---------------------------------------------------------
    let currentPageFiles = 1;
    let itemsPerPageFiles = 10;
    let filteredRowsFiles = [];
    let sortKeyFiles = 'name';
    let sortDirectionFiles = 'asc';

    function updateTableFiles() {
        const tableBody = document.getElementById('trainingFilesBody');
        if (!tableBody) return;

        const rows = Array.from(tableBody.querySelectorAll('tr'));
        const nameFilter = document.getElementById('filterNameFiles')?.value.toLowerCase() || '';

        // Filtro local
        filteredRowsFiles = rows.filter(row => {
            const tdName = row.querySelector('td[data-value]');
            const fileName = tdName ? tdName.getAttribute('data-value') : '';
            return fileName.includes(nameFilter);
        });

        // Ordenação
        sortTableFiles();

        // Paginação
        const totalItems = filteredRowsFiles.length;
        const totalCounter = document.getElementById('paginationTotalFiles');
        if (totalCounter) totalCounter.textContent = totalItems;

        const totalPages = Math.max(1, Math.ceil(totalItems / itemsPerPageFiles));
        if (currentPageFiles > totalPages) currentPageFiles = totalPages;

        const startIndex = (currentPageFiles - 1) * itemsPerPageFiles;
        const endIndex = Math.min(startIndex + itemsPerPageFiles, totalItems);

        document.getElementById('paginationFromFiles').textContent = totalItems === 0 ? 0 : startIndex + 1;
        document.getElementById('paginationToFiles').textContent = endIndex;

        rows.forEach(r => (r.style.display = 'none'));
        filteredRowsFiles.slice(startIndex, endIndex).forEach(r => {
            r.style.display = '';
        });

        updatePaginationFiles(totalPages);
    }

    function sortTableFiles() {
        const tableBody = document.getElementById('trainingFilesBody');
        if (!tableBody) return;

        filteredRowsFiles.sort((a, b) => {
            let aValue, bValue;

            if (sortKeyFiles === 'name') {
                aValue = a.querySelector('td[data-value]')?.getAttribute('data-value') || '';
                bValue = b.querySelector('td[data-value]')?.getAttribute('data-value') || '';
            } else if (sortKeyFiles === 'uploaded_at') {
                const aCell = a.querySelectorAll('td')[1];
                const bCell = b.querySelectorAll('td')[1];
                aValue = aCell ? aCell.getAttribute('data-value') : '';
                bValue = bCell ? bCell.getAttribute('data-value') : ''; // Corrigido: era aCell em vez de bCell
            } else if (sortKeyFiles === 'file_size') {
                const aCell = a.querySelectorAll('td')[2];
                const bCell = b.querySelectorAll('td')[2]; // Corrigido: era a.querySelectorAll em vez de b.querySelectorAll
                aValue = aCell ? parseInt(aCell.getAttribute('data-value') || '0') : 0;
                bValue = bCell ? parseInt(b.getAttribute('data-value') || '0') : 0;
            } else {
                aValue = '';
                bValue = '';
            }

            if (sortKeyFiles === 'uploaded_at') {
                const dateA = new Date(aValue);
                const dateB = new Date(bValue);
                return sortDirectionFiles === 'asc' ? (dateA - dateB) : (dateB - dateA);
            } else if (sortKeyFiles === 'file_size') {
                return sortDirectionFiles === 'asc' ? (aValue - bValue) : (bValue - aValue);
            }
            return sortDirectionFiles === 'asc'
                ? String(aValue).localeCompare(String(bValue))
                : String(bValue).localeCompare(String(aValue));
        });

        // Ajusta ícones
        document.querySelectorAll('#trainingFiles thead th.sortable').forEach(th => {
            const icon = th.querySelector('.sort-icon');
            if (!icon) return;

            const key = th.dataset.sortKey;
            th.classList.remove('active-sort');
            icon.classList.remove(
                'bi-sort-alpha-down','bi-sort-alpha-up',
                'bi-sort-numeric-down','bi-sort-numeric-up'
            );

            if (key === sortKeyFiles) {
                if (sortKeyFiles === 'uploaded_at' || sortKeyFiles === 'file_size') {
                    if (sortDirectionFiles === 'asc') icon.classList.add('bi-sort-numeric-down');
                    else icon.classList.add('bi-sort-numeric-up');
                } else {
                    if (sortDirectionFiles === 'asc') icon.classList.add('bi-sort-alpha-down');
                    else icon.classList.add('bi-sort-alpha-up');
                }
                th.classList.add('active-sort');
            } else {
                if (key === 'uploaded_at' || key === 'file_size') {
                    icon.classList.add('bi-sort-numeric-down');
                } else {
                    icon.classList.add('bi-sort-alpha-down');
                }
            }
        });

        filteredRowsFiles.forEach(row => tableBody.appendChild(row));
    }

    function updatePaginationFiles(totalPages) {
        const pagination = document.getElementById('paginationFiles');
        if (!pagination) return;

        const prevPageBtn = pagination.querySelector('li:first-child');
        const nextPageBtn = pagination.querySelector('li:last-child');

        prevPageBtn.classList.toggle('disabled', currentPageFiles <= 1);
        nextPageBtn.classList.toggle('disabled', currentPageFiles >= totalPages);

        Array.from(pagination.querySelectorAll('li:not(:first-child):not(:last-child)')).forEach(li => li.remove());

        let pagesToShow = [];
        if (totalPages <= 5) {
            pagesToShow = Array.from({ length: totalPages }, (_, i) => i + 1);
        } else {
            pagesToShow = [1];
            if (currentPageFiles > 3) pagesToShow.push('...');
            for (let i = Math.max(2, currentPageFiles - 1); i <= Math.min(totalPages - 1, currentPageFiles + 1); i++) {
                pagesToShow.push(i);
            }
            if (currentPageFiles < totalPages - 2) pagesToShow.push('...');
            if (totalPages > 1) pagesToShow.push(totalPages);
        }

        const nextPageElement = pagination.querySelector('li:last-child');
        pagesToShow.forEach(pageNum => {
            const li = document.createElement('li');
            if (pageNum === '...') {
                li.className = 'page-item disabled';
                li.innerHTML = '<span class="page-link">...</span>';
            } else {
                li.className = `page-item ${currentPageFiles === pageNum ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" data-page="${pageNum}">${pageNum}</a>`;
                if (currentPageFiles !== pageNum) {
                    li.querySelector('a').addEventListener('click', e => {
                        e.preventDefault();
                        currentPageFiles = parseInt(e.target.dataset.page);
                        updateTableFiles();
                    });
                }
            }
            pagination.insertBefore(li, nextPageElement);
        });
    }

    // ---------------------------------------------------------
    // 2) GERENCIAMENTO DOS STATUS DE TREINAMENTO
    // ---------------------------------------------------------
    let trainingsData = [];   
    let currentPageStatus = 1;
    let itemsPerPageStatus = 10;
    let sortKeyStatus = 'ai_name';
    let sortDirectionStatus = 'asc';
    let filteredTrainingsStatus = [];

    function updateStatusFromServer() {
        ajaxAPI("{% url 'ai_config:training_monitor' %}", "GET", null, { showLoading: false, showSuccess: false })
        .then(response => {
            // Extrair dados do objeto APPResponse
            const responseData = response.getData();
            
            // Verificar se é um array e extrair o primeiro item
            const data = Array.isArray(responseData) && responseData.length > 0 
                ? responseData[0] 
                : responseData || {};
            
            // Verificar se temos os dados na estrutura esperada
            const queueStatus = data.queue_status || { queued: 0, finished: 0, started: 0 };
            
            // Atualizar contadores de status com verificações de segurança
            document.getElementById('queuedCount').textContent = queueStatus.queued || 0;
            document.getElementById('completedCount').textContent = queueStatus.finished || 0;
            document.getElementById('processingCount').textContent = queueStatus.started || 0;
            
            // Atualizar dados dos treinamentos
            trainingsData = data.trainings || [];
            renderTrainingsTable();
        })
        .catch(error => {
            console.error('Erro ao buscar status:', error);
            showStatusLoadError();
        });
    }
    
    // Função para indicar visualmente erro no carregamento de status
    function showStatusLoadError() {
        
        // Adiciona indicação visual à tabela de status
        const statusBody = document.getElementById('trainingStatusBody');
        if (statusBody) {
            if (trainingsData.length === 0) {
                statusBody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center py-4">
                            <i class="bi bi-exclamation-triangle-fill fs-2 text-danger"></i>
                            <p class="mt-2 mb-0 text-danger">Erro ao carregar dados de treinamento</p>
                            <button class="btn btn-sm btn-outline-primary mt-3" onclick="updateStatusFromServer()">
                                <i class="bi bi-arrow-clockwise"></i> Tentar novamente
                            </button>
                        </td>
                    </tr>
                `;
            }
        }
    }

    function renderTrainingsTable() {
        const nameFilter = (document.getElementById('filterNameStatus')?.value || '').toLowerCase();
        const statusFilter = document.getElementById('filterStatusStatus')?.value || '';

        filteredTrainingsStatus = trainingsData.filter(t => {
            const matchesName = t.ai_name.toLowerCase().includes(nameFilter);
            const matchesStatus = !statusFilter || (t.status === statusFilter);
            return matchesName && matchesStatus;
        });

        sortTrainingsTable();

        const totalItems = filteredTrainingsStatus.length;
        const totalPages = Math.max(1, Math.ceil(totalItems / itemsPerPageStatus));
        if (currentPageStatus > totalPages) currentPageStatus = totalPages;

        const startIndex = (currentPageStatus - 1) * itemsPerPageStatus;
        const endIndex = Math.min(startIndex + itemsPerPageStatus, totalItems);

        document.getElementById('paginationTotalStatus').textContent = totalItems === 0 ? 0 : totalItems;
        document.getElementById('paginationFromStatus').textContent = totalItems === 0 ? 0 : startIndex + 1;
        document.getElementById('paginationToStatus').textContent = endIndex;

        const rowsHtml = filteredTrainingsStatus.slice(startIndex, endIndex).map(t => getTrainingRowHTML(t)).join('');
        document.getElementById('trainingStatusBody').innerHTML = rowsHtml || '';
        updatePaginationStatus(totalPages);

        // Re-inicializa tooltips e Clipboard
        document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => {
            const existing = bootstrap.Tooltip.getInstance(el);
            if (existing) existing.dispose();
            new bootstrap.Tooltip(el);
        });
        const clipboard = new ClipboardJS('.copy-btn');
        clipboard.on('success', function(e) {
            const button = e.trigger;
            const original = button.innerHTML;
            button.innerHTML = '<i class="bi bi-check"></i>';
            button.classList.add('btn-success');
            button.classList.remove('btn-outline-secondary');
            setTimeout(() => {
                button.innerHTML = original;
                button.classList.remove('btn-success');
                button.classList.add('btn-outline-secondary');
            }, 1000);
            e.clearSelection();
        });
    }

    function sortTrainingsTable() {
        filteredTrainingsStatus.sort((a, b) => {
            let aValue = '', bValue = '';
            if (sortKeyStatus === 'ai_name') {
                aValue = a.ai_name.toLowerCase();
                bValue = b.ai_name.toLowerCase();
            } else if (sortKeyStatus === 'status') {
                aValue = a.status;
                bValue = b.status;
            } else if (sortKeyStatus === 'model_name') {
                aValue = (a.model_name || '').toLowerCase();
                bValue = (b.model_name || '').toLowerCase();
            }

            if (sortDirectionStatus === 'asc') {
                return aValue.localeCompare(bValue);
            } else {
                return bValue.localeCompare(aValue);
            }
        });

        // Ajusta ícones da tabela #trainingStatusTable
        document.querySelectorAll('#trainingStatusTable thead th.sortable').forEach(th => {
            const icon = th.querySelector('.sort-icon');
            if (!icon) return;

            const key = th.dataset.sortKey;
            th.classList.remove('active-sort');
            icon.classList.remove(
                'bi-sort-alpha-down','bi-sort-alpha-up',
                'bi-sort-numeric-down','bi-sort-numeric-up'
            );

            if (key === sortKeyStatus) {
                if (sortDirectionStatus === 'asc') {
                    icon.classList.add('bi-sort-alpha-down');
                } else {
                    icon.classList.add('bi-sort-alpha-up');
                }
                th.classList.add('active-sort');
            } else {
                icon.classList.add('bi-sort-alpha-down');
            }
        });
    }

    function getTrainingRowHTML(training) {
        const bgColor = getStatusBackgroundColor(training.status);
        const statusColor = getStatusColor(training.status);
        const statusText = getStatusTranslation(training.status);

        let modelCellHtml = '-';
        if (training.status === 'in_progress') {
            modelCellHtml = `
                <div class="progress mb-1" style="height: 4px;">
                    <div class="progress-bar bg-${statusColor} progress-bar-striped progress-bar-animated" 
                         role="progressbar" 
                         style="width: ${training.progress * 100}%"></div>
                </div>
                <small class="text-muted">${Math.round(training.progress * 100)}% concluído</small>
            `;
        } else if (training.model_name) {
            const completedAtHtml = training.completed_at ? `
                <small class="text-muted">
                    <i class="bi bi-clock"></i> Criado em: ${new Date(training.completed_at).toLocaleString()}
                </small>` : '';

            modelCellHtml = `
                <div class="d-flex align-items-center">
                    <span class="model-id me-2">${training.model_name}</span>
                    <div class="copy-wrapper" data-bs-toggle="tooltip" title="Copiar nome do modelo">
                        <button class="btn btn-sm btn-outline-secondary copy-btn" data-clipboard-text="${training.model_name}">
                            <i class="bi bi-clipboard"></i>
                        </button>
                    </div>
                </div>
                ${completedAtHtml}
            `;
        }

        const errorIconHtml = training.error ? `
            <i class="bi bi-exclamation-triangle-fill text-warning ms-2 error-icon"
               data-bs-toggle="tooltip"
               title="Clique para ver detalhes do erro"
               onclick="showError('${encodeURIComponent(training.error)}')"></i>
        ` : '';

        let actionBtnHtml = `
            <button class="btn btn-sm btn-danger" 
                    onclick="openDeleteTrainingModal('${training.id}', '${training.model_name || training.ai_name}')">
                <i class="bi bi-trash"></i> Excluir
            </button>
        `;
        if (training.status === 'in_progress') {
            actionBtnHtml = `
                <button class="btn btn-sm btn-danger" 
                        onclick="openCancelModal('${training.id}', '${training.ai_name}')">
                    <i class="bi bi-x-circle"></i> Cancelar
                </button>
            `;
        }

        return `
            <tr class="${bgColor}">
                <td>
                    <div class="d-flex flex-column">
                        <span class="model-name">${training.ai_name}</span>
                    </div>
                </td>
                <td>
                    <div class="d-flex align-items-center">
                        <span class="badge bg-${statusColor} text-status">${statusText}</span>
                        ${errorIconHtml}
                    </div>
                </td>
                <td>${modelCellHtml}</td>
                <td>
                    <div class="d-flex justify-content-end gap-2">
                        ${actionBtnHtml}
                    </div>
                </td>
            </tr>
        `;
    }

    function updatePaginationStatus(totalPages) {
        const pagination = document.getElementById('paginationStatus');
        if (!pagination) return;

        const prevPageBtn = pagination.querySelector('li:first-child');
        const nextPageBtn = pagination.querySelector('li:last-child');

        prevPageBtn.classList.toggle('disabled', currentPageStatus <= 1);
        nextPageBtn.classList.toggle('disabled', currentPageStatus >= totalPages);

        Array.from(pagination.querySelectorAll('li:not(:first-child):not(:last-child)')).forEach(li => li.remove());

        let pagesToShow = [];
        if (totalPages <= 5) {
            pagesToShow = Array.from({ length: totalPages }, (_, i) => i + 1);
        } else {
            pagesToShow = [1];
            if (currentPageStatus > 3) pagesToShow.push('...');
            for (let i = Math.max(2, currentPageStatus - 1); i <= Math.min(totalPages - 1, currentPageStatus + 1); i++) {
                pagesToShow.push(i);
            }
            if (currentPageStatus < totalPages - 2) pagesToShow.push('...');
            if (totalPages > 1) pagesToShow.push(totalPages);
        }

        const nextPageElement = pagination.querySelector('li:last-child');
        pagesToShow.forEach(pageNum => {
            const li = document.createElement('li');
            if (pageNum === '...') {
                li.className = 'page-item disabled';
                li.innerHTML = '<span class="page-link">...</span>';
            } else {
                li.className = `page-item ${currentPageStatus === pageNum ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" data-page="${pageNum}">${pageNum}</a>`;
                if (currentPageStatus !== pageNum) {
                    li.querySelector('a').addEventListener('click', e => {
                        e.preventDefault();
                        currentPageStatus = parseInt(e.target.dataset.page);
                        renderTrainingsTable();
                    });
                }
            }
            pagination.insertBefore(li, nextPageElement);
        });
    }

    // ---------------------------------------------------------
    // 3) FUNÇÕES AUXILIARES E DE AÇÃO
    // ---------------------------------------------------------
    function getStatusTranslation(status) {
        return {
            'not_started': 'Não iniciado',
            'in_progress': 'Em andamento',
            'completed': 'Concluído',
            'failed': 'Falhou'
        }[status] || status;
    }

    function getStatusBackgroundColor(status) {
        return {
            'not_started': 'bg-light',
            'in_progress': 'bg-info-subtle',
            'completed': 'bg-success-subtle',
            'failed': 'bg-danger-subtle'
        }[status] || '';
    }

    function getStatusColor(status) {
        return {
            'not_started': 'secondary',
            'in_progress': 'primary',
            'completed': 'success',
            'failed': 'danger'
        }[status] || 'secondary';
    }

    function startTraining(fileId) {
        // Verificar se o arquivo está vazio antes de abrir o modal
        const fileSizeCell = document.querySelector(`tr td[data-value="0"].file-size`);
        const row = fileSizeCell ? fileSizeCell.closest('tr') : null;
        
        if (row) {
            showMessage('warning', 'Arquivos vazios não podem ser usados para treinamento. Por favor, adicione dados ao arquivo antes de continuar.');
            return;
        }
        
        document.getElementById('selectedFileId').value = fileId;
        new bootstrap.Modal(document.getElementById('trainingModal')).show();
    }

    function cancelTraining(jobId) {
        showLoading('confirmCancel');
        fetch(buildUrl("{% url 'ai_config:training_cancel' '999999999' %}", "999999999", jobId) + "?no_loader=true", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            const modal = bootstrap.Modal.getInstance(document.getElementById('cancelTrainingModal'));
            if (modal) modal.hide();
            
            if (data.success) {
                showMessage('success', data.data?.message || 'Treinamento cancelado com sucesso');
            } else {
                showMessage('error', data.error || 'Erro ao cancelar treinamento');
            }
            
            // Atualizar dados após curto delay
            setTimeout(() => {
                updateStatusFromServer();
            }, 500);
        })
        .catch(error => {
            hideLoading('confirmCancel');
            showMessage('error', 'Erro ao processar solicitação: ' + error.message);
            updateStatusFromServer();
        });
    }

    document.getElementById('confirmCancel').addEventListener('click', () => {
        const trainingId = document.getElementById('cancelTrainingId').value;
        cancelTraining(trainingId);
    });

    function downloadFile(fileId) {
        // Evitar ativação do loader de transição adicionando ?no_loader=true na URL
        const downloadUrl = buildUrl("{% url 'ai_config:training_file_download' '999999999' %}", "999999999", fileId) + "?no_loader=true";
        
        // Usar iframe oculto para download sem navegação
        const iframe = document.createElement('iframe');
        iframe.style.display = 'none';
        iframe.src = downloadUrl;
        document.body.appendChild(iframe);
        
        // Remover iframe após um tempo
        setTimeout(() => {
            document.body.removeChild(iframe);
        }, 5000);
    }

    function openDeleteFileModal(fileId, fileName) {
        openDeleteModal(fileId, fileName, 'file');
    }

    function openDeleteTrainingModal(trainingId, modelName) {
        openDeleteModal(trainingId, modelName, 'training');
    }

    function openDeleteModal(id, name, type = 'file') {
        document.getElementById('deleteItemId').value = id;
        document.getElementById('deleteItemName').textContent = name;
        document.getElementById('deleteItemAction').value = type;
        document.getElementById('deleteItemType').textContent = type === 'file' ? 'o arquivo' : 'o modelo';
        new bootstrap.Modal(document.getElementById('deleteModal')).show();
    }

    document.getElementById('confirmDelete').addEventListener('click', () => {
        const id = document.getElementById('deleteItemId').value;
        const type = document.getElementById('deleteItemAction').value;

        showLoading('confirmDelete');
        
        let url;
        if (type === 'file') {
            url = buildUrl("{% url 'ai_config:training_file_delete' '999999999' %}", "999999999", id);
        } else {
            url = buildUrl("{% url 'ai_config:training_delete' '999999999' %}", "999999999", id);
        }
        
        url += "?no_loader=true";
        
        ajaxAPI(url, 'POST', null, {
            showLoading: false
        })
        .then(response => {
            hideLoading('confirmDelete');
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
            if (modal) modal.hide();
            
            // Exibir mensagem de sucesso usando o método da classe APIResponse
            response.showMessage();
            
            // Atualizar dados após curto delay
            setTimeout(() => {
                if (type === 'training') {
                    updateStatusFromServer();
                } else {
                    location.reload();
                }
            }, 500);
        })
        .catch(error => {
            hideLoading('confirmDelete');
            
            if (error instanceof APIResponse) {
                error.showMessage();
            } else {
                showMessage('error', 'Erro ao processar solicitação: ' + error.message);
            }
            
            setTimeout(() => {
                updateStatusFromServer();
            }, 500);
        });
    });

    function openCancelModal(id, name) {
        document.getElementById('cancelTrainingId').value = id;
        document.getElementById('cancelModelName').textContent = name;
        new bootstrap.Modal(document.getElementById('cancelTrainingModal')).show();
    }

    function showError(encodedError) {
        const error = decodeURIComponent(encodedError);
        document.querySelector('#errorModal .error-details').textContent = error;
        new bootstrap.Modal(document.getElementById('errorModal')).show();
    }

    function showLoading(buttonId) {
        const button = document.getElementById(buttonId);
        if (button) {
            button.disabled = true;
            button.querySelector('.normal-state')?.classList.add('d-none');
            button.querySelector('.loading-state')?.classList.remove('d-none');
        }
    }

    function hideLoading(buttonId) {
        const button = document.getElementById(buttonId);
        if (button) {
            button.disabled = false;
            button.querySelector('.normal-state')?.classList.remove('d-none');
            button.querySelector('.loading-state')?.classList.add('d-none');
        }
    }

    // ---------------------------------------------------------
    // 4) APLICAÇÃO DE FILTROS NO MODAL DE TREINAMENTO
    // ---------------------------------------------------------
    function applyFilters() {
        const selectedClientType = document.getElementById('apiClientFilter').value;
        const aiItems = document.querySelectorAll('.ai-item');
        aiItems.forEach(item => {
            const apiType = item.dataset.apiType;
            const isChecked = item.querySelector('input[type="checkbox"]').checked;
            if (isChecked || !selectedClientType || apiType === selectedClientType) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
        updateSelectedCount();
    }

    function updateSelectedCount() {
        const count = document.querySelectorAll('.ai-item:not([style*="display: none"]) input[type="checkbox"]:checked').length;
        document.getElementById('aiCount').textContent = `${count} selecionada${count !== 1 ? 's' : ''}`;
    }

    // ---------------------------------------------------------
    // 5) DOMContentLoaded - Inicialização
    // ---------------------------------------------------------
    document.addEventListener('DOMContentLoaded', function() {
        // 5.1) Atualização do Status - fetch periódico
        updateStatusFromServer();
        setInterval(updateStatusFromServer, 30000);

        // 5.2) Upload de Arquivo - Refatorado
        const uploadForm = document.getElementById('uploadForm');
        const uploadButton = document.getElementById('uploadButton');
        
        uploadForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Mostrar estado de carregamento
            uploadButton.disabled = true;
            uploadButton.querySelector('.normal-state').classList.add('d-none');
            uploadButton.querySelector('.loading-state').classList.remove('d-none');
            
            const formData = new FormData(this);
            
            fetch("{% url 'ai_config:training_file_upload' %}", {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erro na resposta do servidor: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Fechar o modal e recarregar a página em caso de sucesso
                    const modal = bootstrap.Modal.getInstance(document.getElementById('uploadModal'));
                    if (modal) modal.hide();
                    
                    showMessage('success', data.data?.message || 'Arquivo enviado com sucesso!');
                    
                    // Pequeno atraso para mostrar a mensagem antes de recarregar
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    // Mostrar mensagem de erro
                    showMessage('error', data.error || 'Erro ao fazer upload do arquivo');
                    
                    // Resetar o estado do botão
                    uploadButton.disabled = false;
                    uploadButton.querySelector('.normal-state').classList.remove('d-none');
                    uploadButton.querySelector('.loading-state').classList.add('d-none');
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                showMessage('error', 'Erro ao processar o upload: ' + error.message);
                
                // Resetar o estado do botão
                uploadButton.disabled = false;
                uploadButton.querySelector('.normal-state').classList.remove('d-none');
                uploadButton.querySelector('.loading-state').classList.add('d-none');
            });
        });

        // 5.3) Formulário de Iniciar Treinamento
        const trainingForm = document.getElementById('trainingForm');
        const startTrainingBtn = document.getElementById('startTrainingBtn');
        trainingForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Mostrar loading no botão
            showLoading('startTrainingBtn');

            const selectedAIs = document.querySelectorAll('.ai-item input[type="checkbox"]:checked');
            if (selectedAIs.length === 0) {
                showMessage('warning', 'Selecione pelo menos uma IA para treinamento');
                hideLoading('startTrainingBtn');
                return;
            }

            const formData = new FormData();
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
            formData.append('file_id', document.getElementById('selectedFileId').value);
            
            selectedAIs.forEach(checkbox => {
                formData.append('selected_ais', checkbox.value);
            });
            
            // Usar URL com no_loader=true para evitar o loader de transição
            fetch("{% url 'ai_config:training_ai' %}?no_loader=true", {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                const modal = bootstrap.Modal.getInstance(document.getElementById('trainingModal'));
                
                // Exibir mensagens de acordo com o resultado
                if (data.success) {
                    if (data.data?.success_message) {
                        showMessage('success', data.data.success_message);
                    } else {
                        showMessage('success', 'Treinamento iniciado com sucesso!');
                    }
                    // Fechar modal apenas em caso de sucesso
                    if (modal) modal.hide();
                } else {
                    if (data.error) {
                        showMessage('error', data.error);
                    } else if (data.data?.error_message) {
                        showMessage('error', data.data.error_message);
                    } else {
                        showMessage('error', 'Erro ao iniciar treinamento');
                    }
                }
                
                // Atualizar dados
                setTimeout(() => {
                    updateStatusFromServer();
                }, 500);
            })
            .catch(error => {
                console.error('Erro:', error);
                showMessage('error', 'Ocorreu um erro ao enviar o formulário. Por favor, tente novamente.');
                setTimeout(() => {
                    updateStatusFromServer();
                }, 500);
            })
            .finally(() => {
                hideLoading('startTrainingBtn');
            });
        });

        // 5.4) Botão de Parar Captura
        const stopCaptureBtn = document.getElementById('stopCapture');
        if (stopCaptureBtn) {
            stopCaptureBtn.addEventListener('click', () => {
                fetch("{% url 'ai_config:capture_toggle' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ action: 'stop' })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        showToast('error', data.error || 'Erro ao parar captura');
                    }
                });
            });
        }

        // 5.5) Filtro por API (Modal) e contagem
        document.getElementById('apiClientFilter').addEventListener('change', applyFilters);
        document.querySelectorAll('.ai-item input[type="checkbox"]').forEach(chk => {
            chk.addEventListener('change', updateSelectedCount);
        });
        updateSelectedCount();

        // 5.6) Tabela de Arquivos - restaurar preferências e inicializar
        const itemsPerPageSelect = document.getElementById('itemsPerPageFiles');
        if (itemsPerPageSelect) itemsPerPageFiles = parseInt(itemsPerPageSelect.value) || 10;

        const savedItemsPerPage = sessionStorage.getItem('trainingFilesItemsPerPage');
        if (savedItemsPerPage && itemsPerPageSelect && itemsPerPageSelect.querySelector(`option[value="${savedItemsPerPage}"]`)) {
            itemsPerPageSelect.value = savedItemsPerPage;
            itemsPerPageFiles = parseInt(savedItemsPerPage);
        }
        const savedSortKey = sessionStorage.getItem('trainingFilesSortKey');
        const savedSortDir = sessionStorage.getItem('trainingFilesSortDirection');
        if (savedSortKey) sortKeyFiles = savedSortKey;
        if (savedSortDir) sortDirectionFiles = savedSortDir;

        const filterControlsFiles = document.getElementById('filterControlsFiles');
        const toggleFiltersIcon = document.querySelector('.toggle-filters i:last-child');
        if (filterControlsFiles && toggleFiltersIcon) {
            const savedFiltersVisible = sessionStorage.getItem('trainingFilesFiltersVisible');
            if (savedFiltersVisible === 'false') {
                filterControlsFiles.style.display = 'none';
                toggleFiltersIcon.classList.replace('bi-chevron-down', 'bi-chevron-up');
            }
        }

        document.getElementById('itemsPerPageFiles')?.addEventListener('change', e => {
            itemsPerPageFiles = parseInt(e.target.value);
            sessionStorage.setItem('trainingFilesItemsPerPage', itemsPerPageFiles);
            currentPageFiles = 1;
            updateTableFiles();
        });
        document.getElementById('prevPageFiles')?.addEventListener('click', e => {
            e.preventDefault();
            if (currentPageFiles > 1) {
                currentPageFiles--;
                updateTableFiles();
            }
        });
        document.getElementById('nextPageFiles')?.addEventListener('click', e => {
            e.preventDefault();
            const totalPages = Math.ceil(filteredRowsFiles.length / itemsPerPageFiles);
            if (currentPageFiles < totalPages) {
                currentPageFiles++;
                updateTableFiles();
            }
        });
        document.querySelectorAll('#trainingFiles thead th.sortable').forEach(th => {
            th.addEventListener('click', () => {
                const key = th.dataset.sortKey;
                if (key === sortKeyFiles) {
                    sortDirectionFiles = (sortDirectionFiles === 'asc' ? 'desc' : 'asc');
                } else {
                    sortKeyFiles = key;
                    sortDirectionFiles = 'asc';
                }
                sessionStorage.setItem('trainingFilesSortKey', sortKeyFiles);
                sessionStorage.setItem('trainingFilesSortDirection', sortDirectionFiles);
                updateTableFiles();
            });
        });
        document.querySelectorAll('.filter-files').forEach(el => {
            el.addEventListener('input', () => {
                el.classList.toggle('is-valid', el.value !== '');
                currentPageFiles = 1;
                updateTableFiles();
            });
        });
        document.querySelector('.toggle-filters')?.addEventListener('click', function() {
            if (!filterControlsFiles) return;
            const icon = this.querySelector('i:last-child');
            if (!icon) return;
            if (filterControlsFiles.style.display === 'none') {
                filterControlsFiles.style.display = 'block';
                icon.classList.replace('bi-chevron-up', 'bi-chevron-down');
                sessionStorage.setItem('trainingFilesFiltersVisible', 'true');
            } else {
                filterControlsFiles.style.display = 'none';
                icon.classList.replace('bi-chevron-down', 'bi-chevron-up');
                sessionStorage.setItem('trainingFilesFiltersVisible', 'false');
            }
        });

        updateTableFiles();

        // 5.7) Tabela de Status - restaurar preferências
        const itemsPerPageStatusSelect = document.getElementById('itemsPerPageStatus');
        if (itemsPerPageStatusSelect) itemsPerPageStatus = parseInt(itemsPerPageStatusSelect.value);

        const savedItemsPerPageStatus = sessionStorage.getItem('trainingStatusItemsPerPage');
        if (savedItemsPerPageStatus && itemsPerPageStatusSelect?.querySelector(`option[value="${savedItemsPerPageStatus}"]`)) {
            itemsPerPageStatusSelect.value = savedItemsPerPageStatus;
            itemsPerPageStatus = parseInt(savedItemsPerPageStatus);
        }
        const savedSortKeyStatus = sessionStorage.getItem('trainingStatusSortKey');
        const savedSortDirStatus = sessionStorage.getItem('trainingStatusSortDirection');
        if (savedSortKeyStatus) sortKeyStatus = savedSortKeyStatus;
        if (savedSortDirStatus) sortDirectionStatus = savedSortDirStatus;

        const filterControlsStatus = document.getElementById('filterControlsStatus');
        const toggleFiltersStatusIcon = document.querySelector('.toggle-filters-status i:last-child');
        if (filterControlsStatus && toggleFiltersStatusIcon) {
            const savedFiltersVisibleStatus = sessionStorage.getItem('trainingStatusFiltersVisible');
            if (savedFiltersVisibleStatus === 'false') {
                filterControlsStatus.style.display = 'none';
                toggleFiltersStatusIcon.classList.replace('bi-chevron-down', 'bi-chevron-up');
            }
        }

        document.getElementById('itemsPerPageStatus')?.addEventListener('change', e => {
            itemsPerPageStatus = parseInt(e.target.value);
            sessionStorage.setItem('trainingStatusItemsPerPage', itemsPerPageStatus);
            currentPageStatus = 1;
            renderTrainingsTable();
        });
        document.getElementById('prevPageStatus')?.addEventListener('click', e => {
            e.preventDefault();
            if (currentPageStatus > 1) {
                currentPageStatus--;
                renderTrainingsTable();
            }
        });
        document.getElementById('nextPageStatus')?.addEventListener('click', e => {
            e.preventDefault();
            const totalPages = Math.ceil(filteredTrainingsStatus.length / itemsPerPageStatus);
            if (currentPageStatus < totalPages) {
                currentPageStatus++;
                renderTrainingsTable();
            }
        });
        // Ordenação específica da tabela #trainingStatusTable
        document.querySelectorAll('#trainingStatusTable thead th.sortable').forEach(th => {
            th.addEventListener('click', () => {
                const key = th.dataset.sortKey;
                if (key === sortKeyStatus) {
                    sortDirectionStatus = (sortDirectionStatus === 'asc' ? 'desc' : 'asc');
                } else {
                    sortKeyStatus = key;
                    sortDirectionStatus = 'asc';
                }
                sessionStorage.setItem('trainingStatusSortKey', sortKeyStatus);
                sessionStorage.setItem('trainingStatusSortDirection', sortDirectionStatus);
                renderTrainingsTable();
            });
        });
        document.querySelectorAll('.filter-status').forEach(el => {
            el.addEventListener('input', () => {
                currentPageStatus = 1;
                renderTrainingsTable();
            });
        });
        document.querySelector('.toggle-filters-status')?.addEventListener('click', function() {
            if (!filterControlsStatus) return;
            const icon = this.querySelector('i:last-child');
            if (!icon) return;
            if (filterControlsStatus.style.display === 'none') {
                filterControlsStatus.style.display = 'block';
                icon.classList.replace('bi-chevron-up', 'bi-chevron-down');
                sessionStorage.setItem('trainingStatusFiltersVisible', 'true');
            } else {
                filterControlsStatus.style.display = 'none';
                icon.classList.replace('bi-chevron-down', 'bi-chevron-up');
                sessionStorage.setItem('trainingStatusFiltersVisible', 'false');
            }
        });
    });
</script>

<style>
    /* Ajustes de layout e estilo */
    .progress {
        height: 4px !important;
        border-radius: 2px;
        background-color: rgba(0,0,0,0.1);
    }
    .text-status {
        min-width: 100px;
        text-align: center;
        font-size: 0.875rem;
    }
    .model-id {
        font-family: monospace;
        font-size: 0.875rem;
    }
    .copy-wrapper {
        display: inline-block;
    }
    .error-details {
        white-space: pre-wrap;
        word-wrap: break-word;
        background: var(--bs-light);
        padding: 1rem;
        border-radius: var(--bs-border-radius);
        margin: 0;
    }
    th.sortable {
        cursor: pointer;
    }
    th.sortable.active-sort {
        text-decoration: underline;
    }
    /* Estilos específicos para arquivos vazios */
    .badge.bg-danger {
        font-size: 0.75rem;
        vertical-align: middle;
    }
    /* Filtros por default abertos */
    #filterControlsFiles,
    #filterControlsStatus {
        display: block;
    }
</style>
{% endblock %}
