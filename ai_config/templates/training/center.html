{% extends 'base.html' %}

{% block content %}
<div class="container py-5">
    <!-- Cabeçalho -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1><i class="bi bi-robot"></i> Central de Treinamento</h1>
                {% if active_capture %}
                    <button id="stopCapture" class="btn btn-danger">
                        <i class="bi bi-stop-circle"></i> Parar Captura
                    </button>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Status do Sistema -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="bi bi-list-check"></i> Treinamentos em Fila
                    </h5>
                    <h2 id="queuedCount">-</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="bi bi-check-circle"></i> Treinamentos Concluídos
                    </h5>
                    <h2 id="completedCount">-</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-warning text-dark">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="bi bi-gear-wide-connected"></i> Em Processamento
                    </h5>
                    <h2 id="processingCount">-</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Conteúdo Principal -->
    <div class="row mb-4">
        <!-- Lista de Arquivos -->
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-file-earmark-text"></i> Arquivos de Treinamento</h5>
                    <div class="btn-group">
                        <a href="{% url 'ai_config:training_file_create' %}" class="btn btn-success btn-sm">
                            <i class="bi bi-file-earmark-plus"></i> Criar Arquivo
                        </a>
                        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#uploadModal">
                            <i class="bi bi-upload"></i> Upload
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush" id="trainingFiles">
                        {% if training_files %}
                            {% for file in training_files %}
                                <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center clickable-row" 
                                     data-file-id="{{ file.id }}">
                                    <div class="file-info">
                                        <h6 class="mb-1">{{ file.name }}</h6>
                                        <small class="text-muted">
                                            Enviado em {{ file.uploaded_at|date:"d/m/Y H:i" }}
                                        </small>
                                    </div>
                                    <div class="btn-group" onclick="event.stopPropagation();">
                                        <button class="btn btn-sm btn-outline-primary" onclick="downloadFile({{ file.id }})">
                                            <i class="bi bi-download"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-success" onclick="startTraining({{ file.id }})">
                                            <i class="bi bi-play-circle"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="openDeleteModal('{{ file.id }}', '{{ file.name }}')">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="list-group-item text-center text-muted">
                                Nenhum arquivo de treinamento encontrado
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Status dos Treinamentos -->
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="bi bi-activity"></i> Status dos Treinamentos</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>IA</th>
                                    <th>Status</th>
                                    <th>Modelo</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="trainingStatus">
                                <!-- O conteúdo será preenchido via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Upload -->
<div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Upload de Arquivo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="uploadForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">Nome do Arquivo</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Arquivo de Treinamento</label>
                        <input type="file" class="form-control" name="file" accept=".json,.jsonl" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-upload"></i> Enviar
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Configuração de Treinamento -->
<div class="modal fade" id="trainingModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Configurar Treinamento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="trainingForm">
                    {% csrf_token %}
                    
                    <!-- Filtros em Card -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="bi bi-funnel"></i> Filtro por API</h6>
                        </div>
                        <div class="card-body">
                            <!-- Filtro por Tipo de IA -->
                            <div class="mb-3">
                                <label class="form-label">Tipo de API</label>
                                <select class="form-select" id="apiClientFilter">
                                    <option value="">Todas as APIs</option>
                                    {% for client_type in api_client_types %}
                                        <option value="{{ client_type }}">{{ client_type }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Lista de IAs -->
                    <div class="mb-3">
                        <label class="form-label d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-robot"></i> IAs Disponíveis para Treinamento</span>
                            <small class="text-muted" id="aiCount">0 selecionadas</small>
                        </label>
                        <div class="list-group" id="aiList">
                            {% for ai in trainable_ais %}
                                <div class="list-group-item ai-item" 
                                     data-api-type="{{ ai.config.ai_client.api_client_class }}">
                                    <div class="form-check d-flex justify-content-between align-items-start">
                                        <div>
                                            <input class="form-check-input" type="checkbox" 
                                                   name="selected_ais" 
                                                   value="{{ ai.config.id }}"
                                                   id="ai_{{ ai.config.id }}">
                                            <label class="form-check-label" for="ai_{{ ai.config.id }}">
                                                {{ ai.config.name }}
                                                <small class="d-block text-muted">
                                                    Tipo: {{ ai.config.ai_client.api_client_class }}
                                                    {% if ai.config.model_name %}
                                                    | Modelo: <span class="badge bg-info text-dark">{{ ai.config.model_name }}</span>
                                                    {% endif %}
                                                </small>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>

                    <input type="hidden" name="file_id" id="selectedFileId">
                    <button type="submit" class="btn btn-success w-100" id="startTrainingBtn">
                        <span class="normal-state">
                            <i class="bi bi-play-circle"></i> Iniciar Treinamento
                        </span>
                        <span class="loading-state d-none">
                            <span class="spinner-border spinner-border-sm" role="status"></span>
                            Iniciando...
                        </span>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Delete -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Exclusão</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja excluir o arquivo <strong id="fileName"></strong>?</p>
                <input type="hidden" id="fileId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">
                    <span class="normal-state">
                        <i class="bi bi-trash"></i> Excluir
                    </span>
                    <span class="loading-state d-none">
                        <span class="spinner-border spinner-border-sm"></span> Excluindo...
                    </span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Delete Training -->
<div class="modal fade" id="deleteTrainingModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Exclusão</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja excluir o modelo <strong id="modelName"></strong>?</p>
                <input type="hidden" id="trainingId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmTrainingDelete">
                    <span class="normal-state">
                        <i class="bi bi-trash"></i> Excluir
                    </span>
                    <span class="loading-state d-none">
                        <span class="spinner-border spinner-border-sm"></span> Excluindo...
                    </span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Erro -->
<div class="modal fade" id="errorModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalhes do Erro</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <pre class="error-details"></pre>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmação de Cancelamento -->
<div class="modal fade" id="cancelTrainingModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Cancelamento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja cancelar o treinamento do modelo <strong id="cancelModelName"></strong>?</p>
                <p class="text-danger">Esta ação não pode ser desfeita.</p>
                <input type="hidden" id="cancelTrainingId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Não</button>
                <button type="button" class="btn btn-danger" id="confirmCancel">
                    <span class="normal-state">
                        <i class="bi bi-x-circle"></i> Cancelar
                    </span>
                    <span class="loading-state d-none">
                        <span class="spinner-border spinner-border-sm"></span> Cancelando...
                    </span>
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    // Adicionar esta função utilitária no início do bloco de script
    function encodeJobId(jobId) {
        return btoa(jobId).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
    }

    function decodeJobId(encodedId) {
        encodedId = encodedId.replace(/-/g, '+').replace(/_/g, '/');
        while (encodedId.length % 4) encodedId += '=';
        return atob(encodedId);
    }

    function getStatusTranslation(status) {
        return {
            'not_started': 'Não iniciado',
            'in_progress': 'Em andamento',
            'completed': 'Concluído',
            'failed': 'Falhou'
        }[status] || status;
    }

    function getStatusBackgroundColor(status) {
        return {
            'not_started': 'bg-light',
            'in_progress': 'bg-info-subtle',
            'completed': 'bg-success-subtle',
            'failed': 'bg-danger-subtle'
        }[status] || '';
    }

    // Atualização periódica do status
    function updateStatus() {
        fetch("{% url 'ai_config:training_status' %}")
            .then(response => response.json())
            .then(data => {
                // Atualiza contadores
                document.getElementById('queuedCount').textContent = data.queue_status.queued;
                document.getElementById('completedCount').textContent = data.queue_status.finished;
                document.getElementById('processingCount').textContent = data.queue_status.started;

                // Atualiza tabela de status
                const tbody = document.getElementById('trainingStatus');
                tbody.innerHTML = data.trainings.map(training => `
                    <tr class="${getStatusBackgroundColor(training.status)}">
                        <td>
                            <div class="d-flex flex-column">
                                <span class="model-name">${training.ai_name}</span>
                            </div>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <span class="badge bg-${training.status_color} text-status">
                                    ${getStatusTranslation(training.status)}
                                </span>
                                ${training.error ? `
                                    <i class="bi bi-exclamation-triangle-fill text-warning ms-2 error-icon"
                                       data-bs-toggle="tooltip"
                                       title="Clique para ver detalhes do erro"
                                       onclick="showError('${encodeURIComponent(training.error)}')"></i>
                                ` : ''}
                            </div>
                        </td>
                        <td>
                            <div class="d-flex flex-column">
                                ${training.status === 'in_progress' ? `
                                    <!-- Em treinamento: mostra barra de progresso -->
                                    <div class="progress mb-1" style="height: 4px;">
                                        <div class="progress-bar bg-${training.status_color} progress-bar-striped progress-bar-animated" 
                                             role="progressbar" 
                                             style="width: ${training.progress * 100}%">
                                        </div>
                                    </div>
                                    <small class="text-muted">${Math.round(training.progress * 100)}% concluído</small>
                                ` : training.model_name ? `
                                    <!-- Concluído: mostra nome do modelo -->
                                    <div class="d-flex align-items-center">
                                        <span class="model-id me-2">${training.model_name}</span>
                                        <div class="copy-wrapper" data-bs-toggle="tooltip" title="Copiar nome do modelo">
                                            <button class="btn btn-sm btn-outline-secondary copy-btn" 
                                                    data-clipboard-text="${training.model_name}">
                                                <i class="bi bi-clipboard"></i>
                                            </button>
                                        </div>
                                    </div>
                                    ${training.completed_at ? `
                                        <small class="text-muted">
                                            <i class="bi bi-clock"></i> Criado em: ${new Date(training.completed_at).toLocaleString()}
                                        </small>
                                    ` : ''}
                                ` : '-'}
                            </div>
                        </td>
                        <td>
                            <div class="btn-group">
                                ${training.status === 'in_progress' ? `
                                    <button class="btn btn-sm btn-danger" 
                                            onclick="openCancelModal('${training.id}', '${training.ai_name}')">
                                        <i class="bi bi-x-circle"></i> Cancelar
                                    </button>
                                ` : `
                                    <button class="btn btn-sm btn-outline-danger" 
                                            onclick="openDeleteTrainingModal('${training.id}', '${training.model_name || training.ai_name}')">
                                        <i class="bi bi-trash"></i> Excluir
                                    </button>
                                `}
                            </div>
                        </td>
                    </tr>
                `).join('');

                // Primeiro destrua todos os tooltips existentes
                document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => {
                    const tooltip = bootstrap.Tooltip.getInstance(el);
                    if (tooltip) {
                        tooltip.dispose();
                    }
                });

                // Então inicialize os novos tooltips
                document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => {
                    new bootstrap.Tooltip(el);
                });

                // Inicializa o Clipboard
                const clipboard = new ClipboardJS('.copy-btn');
                clipboard.on('success', function(e) {
                    const button = e.trigger;
                    const icon = button.innerHTML;
                    
                    // Muda o texto do botão
                    button.innerHTML = '<i class="bi bi-check"></i>';
                    button.classList.add('btn-success');
                    button.classList.remove('btn-outline-secondary');
                    
                    // Reverte após 1 segundo
                    setTimeout(() => {
                        button.innerHTML = icon;
                        button.classList.remove('btn-success');
                        button.classList.add('btn-outline-secondary');
                    }, 1000);
                    
                    e.clearSelection();
                });

                clipboard.on('error', function(e) {
                    console.error('Erro ao copiar:', e);
                });
            });
    }

    // Inicialização
    document.addEventListener('DOMContentLoaded', function() {
        // Atualização inicial e configuração do intervalo
        updateStatus();
        setInterval(updateStatus, 5000);

        // Setup do formulário de upload
        const uploadForm = document.getElementById('uploadForm');
        uploadForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            
            fetch("{% url 'ai_config:training_file_upload' %}", {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    showToast('error', data.error || 'Erro ao fazer upload');
                }
            });
        });

        // Setup do formulário de treinamento
        const trainingForm = document.getElementById('trainingForm');
        const startTrainingBtn = document.getElementById('startTrainingBtn');

        trainingForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Desabilita o botão e mostra loading
            startTrainingBtn.disabled = true;
            startTrainingBtn.querySelector('.normal-state').classList.add('d-none');
            startTrainingBtn.querySelector('.loading-state').classList.remove('d-none');
            
            // Verifica se há IAs selecionadas
            const selectedAIs = document.querySelectorAll('.ai-item input[type="checkbox"]:checked');
            if (selectedAIs.length === 0) {
                location.reload();
                return;
            }

            const formData = new FormData();
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
            formData.append('file_id', document.getElementById('selectedFileId').value);
            
            selectedAIs.forEach(checkbox => {
                formData.append('selected_ais', checkbox.value);
            });
            
            fetch("{% url 'ai_config:training_ai' %}", {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('trainingModal')).hide();
                }
                location.reload();
            })
            .catch(error => {
                console.error('Erro:', error);
                location.reload();
            });
        });

        // Setup do botão de parar captura
        const stopCaptureBtn = document.getElementById('stopCapture');
        if (stopCaptureBtn) {
            stopCaptureBtn.addEventListener('click', function() {
                fetch("{% url 'ai_config:capture_toggle' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ action: 'stop' })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        showToast('error', data.error || 'Erro ao parar captura');
                    }
                });
            });
        }

        // Tornar linhas clicáveis
        document.querySelectorAll('.clickable-row').forEach(row => {
            row.addEventListener('click', function() {
                const fileId = this.dataset.fileId;
                if (fileId) {
                    window.location.href = buildUrl(
                        "{% url 'ai_config:training_file_edit' 999999999 %}", 
                        "999999999", 
                        fileId
                    );
                }
            });
        });

        // Adiciona listener apenas para o filtro de API
        document.getElementById('apiClientFilter').addEventListener('change', applyFilters);

        // Adiciona listener para checkboxes
        document.querySelectorAll('.ai-item input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', updateSelectedCount);
        });

        // Inicializa a contagem
        updateSelectedCount();
    });

    // Funções auxiliares
    function startTraining(fileId) {
        document.getElementById('selectedFileId').value = fileId;
        new bootstrap.Modal(document.getElementById('trainingModal')).show();
    }

    function cancelTraining(jobId) {
        showLoading('confirmCancel');
        
        const encodedJobId = encodeJobId(jobId);
        fetch(`{% url 'ai_config:training_cancel' 'JOBID' %}`.replace('JOBID', encodedJobId), {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            const modal = bootstrap.Modal.getInstance(document.getElementById('cancelTrainingModal'));
            if (modal) {
                modal.hide();
            }
            // Sempre recarrega a página para mostrar as mensagens do Django
            location.reload();
        })
        .catch(error => {
            hideLoading('confirmCancel');
            // Força recarga para mostrar mensagem de erro do Django
            location.reload();
        });
    }

    function downloadFile(fileId) {
        window.location.href = buildUrl(
            "{% url 'ai_config:training_file_download' 999999999 %}", 
            "999999999", 
            fileId
        );
    }

    function openDeleteModal(fileId, fileName) {
        document.getElementById('fileId').value = fileId;
        document.getElementById('fileName').textContent = fileName;
        new bootstrap.Modal(document.getElementById('deleteModal')).show();
    }

    document.getElementById('confirmDelete').addEventListener('click', function() {
        showLoading('confirmDelete');
        const fileId = document.getElementById('fileId').value;
        const url = buildUrl(
            "{% url 'ai_config:training_file_delete' 999999999 %}", 
            "999999999", 
            fileId
        );
        
        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            // Recarrega para mostrar mensagem do Django
            location.reload();
        })
        .catch(error => {
            handleError(error, 'confirmDelete');
        });
    });

    function buildUrl(urlTemplate, placeholder, value) {
        return urlTemplate.replace(placeholder, value);
    }

    // Função para atualizar a contagem de IAs selecionadas
    function updateSelectedCount() {
        const count = document.querySelectorAll('.ai-item:not([style*="display: none"]) input[type="checkbox"]:checked').length;
        document.getElementById('aiCount').textContent = `${count} selecionada${count !== 1 ? 's' : ''}`;
    }

    // Função para aplicar filtro por API
    function applyFilters() {
        const selectedClientType = document.getElementById('apiClientFilter').value;
        const aiItems = document.querySelectorAll('.ai-item');
        
        aiItems.forEach(item => {
            const apiType = item.dataset.apiType;
            const isChecked = item.querySelector('input[type="checkbox"]').checked;
            
            // Se não há filtro ou o tipo corresponde ao filtro ou está selecionado, exibe
            if (isChecked || !selectedClientType || apiType === selectedClientType) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
        
        updateSelectedCount();
    }

    function updateTrainingProgress(jobs) {
        if (!jobs || jobs.length === 0) return;
        
        const params = new URLSearchParams();
        jobs.forEach(job => {
            params.append('job_ids[]', job.jobId);
            params.append('config_ids[]', job.configId);
        });
        
        fetch(`{% url 'ai_config:training_progress' %}?${params.toString()}`)
            .then(response => response.json())
            .then(data => {
                if (data.results) {
                    data.results.forEach(result => {
                        // Atualiza a UI para cada treinamento
                        updateTrainingUI(result);
                    });
                }
            })
            .catch(error => console.error('Erro ao atualizar progresso:', error));
    }

    function updateTrainingUI(training) {
        // Atualiza a interface para um treinamento específico
        const row = document.querySelector(`tr[data-job-id="${training.job_id}"]`);
        if (row) {
            // Atualiza o progresso
            const progressBar = row.querySelector('.progress-bar');
            if (progressBar) {
                progressBar.style.width = `${training.progress}%`;
                progressBar.textContent = `${training.progress}%`;
            }

            // Atualiza o status
            const statusBadge = row.querySelector('.status-badge');
            if (statusBadge) {
                statusBadge.textContent = training.status;
                statusBadge.className = `badge bg-${getStatusColor(training.status)} status-badge`;
            }

            // Se completou, atualiza a página para mostrar as mensagens via Django
            if (training.completed) {
                location.reload();
            }
        }
    }

    function deleteTraining(jobId) {
        showLoading('confirmTrainingDelete');
        
        const encodedJobId = encodeJobId(jobId);
        fetch(`{% url 'ai_config:training_delete' 'JOBID' %}`.replace('JOBID', encodedJobId), {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            location.reload();
        })
        .catch(error => {
            handleError(error, 'confirmTrainingDelete');
        });
    }

    function showError(encodedError) {
        const error = decodeURIComponent(encodedError);
        document.querySelector('#errorModal .error-details').textContent = error;
        new bootstrap.Modal(document.getElementById('errorModal')).show();
    }

    function openDeleteTrainingModal(id, name) {
        document.getElementById('trainingId').value = id;
        document.getElementById('modelName').textContent = name;
        new bootstrap.Modal(document.getElementById('deleteTrainingModal')).show();
    }

    function openCancelModal(id, name) {
        document.getElementById('cancelTrainingId').value = id;
        document.getElementById('cancelModelName').textContent = name;
        new bootstrap.Modal(document.getElementById('cancelTrainingModal')).show();
    }

    // Evento para confirmar exclusão
    document.getElementById('confirmTrainingDelete').addEventListener('click', function(e) {
        const button = e.target;
        button.disabled = true;
        button.innerHTML = `
            <span class="spinner-border spinner-border-sm" role="status"></span>
            Excluindo...
        `;
        
        const trainingId = document.getElementById('trainingId').value;
        deleteTraining(trainingId);
    });

    // Adicione o evento de clique para o botão de confirmar cancelamento
    document.getElementById('confirmCancel').addEventListener('click', function() {
        const trainingId = document.getElementById('cancelTrainingId').value;
        cancelTraining(trainingId);
    });

    function showLoading(buttonId) {
        const button = document.getElementById(buttonId);
        if (button) {
            button.disabled = true;
            button.querySelector('.normal-state')?.classList.add('d-none');
            button.querySelector('.loading-state')?.classList.remove('d-none');
        }
    }

    function hideLoading(buttonId) {
        const button = document.getElementById(buttonId);
        if (button) {
            button.disabled = false;
            button.querySelector('.normal-state')?.classList.remove('d-none');
            button.querySelector('.loading-state')?.classList.add('d-none');
        }
    }

    function handleError(error, buttonId = null) {
        console.error('Erro:', error);
        if (error.message) {
            showError(encodeURIComponent(error.message));
        }
        if (buttonId) {
            hideLoading(buttonId);
        }
    }
</script>

<style>
    .progress {
        height: 20px;
    }
    .card {
        box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
    }
    .list-group-item:hover {
        background-color: rgba(0,0,0,0.02);
    }
    .btn-group .btn {
        padding: 0.25rem 0.5rem;
    }
    .clickable-row {
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .clickable-row:hover {
        background-color: rgba(0, 123, 255, 0.05);
    }
    .file-info {
        flex-grow: 1;
    }
    .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid rgba(0,0,0,.125);
    }

    .form-switch {
        padding-left: 2.5em;
    }

    .form-check-input {
        cursor: pointer;
    }

    .badge {
        font-size: 0.75em;
        padding: 0.4em 0.6em;
    }

    .list-group-item {
        transition: background-color 0.2s ease;
    }

    .list-group-item:hover {
        background-color: rgba(0,0,0,0.02);
    }

    .text-muted {
        color: #6c757d !important;
    }

    .error-icon {
        cursor: pointer;
    }
    
    .copy-wrapper {
        display: inline-block;
    }
    
    .copy-btn {
        padding: 0.1rem 0.3rem;
        font-size: 0.75rem;
        transition: all 0.2s ease;
    }
    
    .error-details {
        white-space: pre-wrap;
        word-wrap: break-word;
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 0.25rem;
        margin: 0;
    }
    
    .model-name {
        font-weight: 500;
    }

    .bg-success-subtle {
        background-color: rgba(25, 135, 84, 0.1);
    }
    
    .bg-danger-subtle {
        background-color: rgba(220, 53, 69, 0.1);
    }
    
    .bg-info-subtle {
        background-color: rgba(13, 202, 240, 0.1);
    }
    
    tr.bg-success-subtle + tr.bg-success-subtle td,
    tr.bg-danger-subtle + tr.bg-danger-subtle td,
    tr.bg-info-subtle + tr.bg-info-subtle td {
        border-top: none;
    }

    .model-id {
        font-family: monospace;
        font-size: 0.875rem;
        color: #0d6efd;
    }

    .spinner-border-sm {
        width: 1rem;
        height: 1rem;
        margin-right: 0.5rem;
    }

    /* Efeito de disabled mais evidente */
    .btn:disabled {
        cursor: not-allowed;
        opacity: 0.65;
    }

    .progress {
        background-color: rgba(0,0,0,0.1);
        border-radius: 2px;
        overflow: hidden;
    }

    .progress-bar {
        background-color: #0d6efd;
    }

    .progress-bar-striped {
        background-image: linear-gradient(45deg,
            rgba(255,255,255,.15) 25%,
            transparent 25%,
            transparent 50%,
            rgba(255,255,255,.15) 50%,
            rgba(255,255,255,.15) 75%,
            transparent 75%,
            transparent
        );
        background-size: 1rem 1rem;
    }

    .progress-bar-animated {
        animation: progress-bar-stripes 1s linear infinite;
    }

    @keyframes progress-bar-stripes {
        0% { background-position: 1rem 0; }
        100% { background-position: 0 0; }
    }

    .text-status {
        font-size: 0.8rem;
        font-weight: 500;
        min-width: 100px;
        text-align: center;
    }

    .progress {
        background-color: rgba(0,0,0,0.1);
        height: 4px !important;
        border-radius: 2px;
    }

    .progress-bar {
        transition: width 0.3s ease;
    }

    /* Cores personalizadas para os status */
    .bg-success {
        background-color: #198754 !important;
    }

    .bg-danger {
        background-color: #dc3545 !important;
    }

    .bg-primary {
        background-color: #0d6efd !important;
    }

    .bg-secondary {
        background-color: #6c757d !important;
    }

    .loading-state {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .loading-state .spinner-border-sm {
        margin-right: 0.5rem;
    }
</style>
{% endblock %}
