{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container py-4">
    <div class="bs-component">
        <!-- Card Principal usando estrutura padrão do Bootswatch -->
        <div class="card border-primary mb-3">
            <!-- Header do Card com estilo Bootswatch -->
            <div class="card-header d-flex justify-content-between align-items-center">
                <h2 class="card-title mb-0">
                    <i class="bi bi-link me-2"></i>
                    Gerenciar IAs para o Token "{{ token.name }}"
                </h2>
                <a href="{% url 'accounts:token_config' token.id %}" class="btn btn-outline-secondary btn-sm" aria-label="Voltar para tela anterior">
                    <i class="bi bi-arrow-left"></i> Voltar
                </a>
            </div>

            <!-- Corpo do Card usando componentes Bootswatch -->
            <div class="card-body">
                {% if ai_configs %}
                    <div class="mb-3">
                        <!-- Filtros e Controles com componentes Bootswatch -->
                        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3 gap-2">
                            <!-- Controles à esquerda -->
                            <div class="d-flex align-items-center mb-2 mb-md-0 flex-wrap gap-2">
                                <button class="btn btn-sm btn-outline-primary toggle-filters" type="button" aria-expanded="true" aria-controls="filterControls">
                                    <i class="bi bi-funnel me-1"></i>Filtros
                                    <i class="bi bi-chevron-down ms-1"></i>
                                </button>
                                
                                <!-- Informação de paginação -->
                                <div class="text-muted d-none d-sm-block">
                                    Mostrando <span id="paginationFrom">1</span> a <span id="paginationTo">10</span> de <span id="paginationTotal">{{ ai_configs|length }}</span>
                                </div>
                            </div>
                            
                            <!-- Controles para ativar/desativar todas as IAs -->
                            <div class="d-flex gap-2 mb-2 mb-md-0">
                                <button class="btn btn-sm btn-success" id="activateAllBtn" title="Ativar todas as IAs">
                                    <i class="bi bi-check-all me-1"></i>Ativar Todas
                                </button>
                                <button class="btn btn-sm btn-secondary" id="deactivateAllBtn" title="Desativar todas as IAs">
                                    <i class="bi bi-x-circle me-1"></i>Desativar Todas
                                </button>
                            </div>
                            
                            <!-- Controles à direita - MODIFICADO para ser mais compacto -->
                            <div class="input-group input-group-sm" style="width: auto; max-width: 200px;">
                                <span class="input-group-text">Itens por página</span>
                                <select id="itemsPerPage" class="form-select form-select-sm">
                                    <option value="5">5</option>
                                    <option value="10" selected>10</option>
                                    <option value="25">25</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                </select>
                            </div>
                        </div>

                        <!-- Filtros Expandidos usando card do Bootswatch -->
                        <div class="card bg-light mb-3" id="filterControls">
                            <div class="card-body">
                                <div class="row g-3">
                                    <!-- Filtro por Nome -->
                                    <div class="col-12 col-md-4">
                                        <label for="filterName" class="form-label">Nome da IA</label>
                                        <input type="text" id="filterName" class="form-control form-control-sm filter" placeholder="Filtrar por nome...">
                                    </div>
                                    
                                    <!-- Filtro por Cliente de API -->
                                    <div class="col-12 col-md-4">
                                        <label for="filterClient" class="form-label">Cliente API</label>
                                        <select id="filterClient" class="form-select form-select-sm filter">
                                            <option value="">Todos os clientes</option>
                                            {% for client_id, client in unique_clients.items %}
                                                <option value="{{ client_id }}">{{ client }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    
                                    <!-- Filtro por Status -->
                                    <div class="col-12 col-md-4">
                                        <label for="filterStatus" class="form-label">Status</label>
                                        <select id="filterStatus" class="form-select form-select-sm filter">
                                            <option value="">Todos os status</option>
                                            <option value="1">Ativas</option>
                                            <option value="0">Inativas</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tabela Responsiva no estilo Bootswatch -->
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th scope="col" class="sortable" data-sort-key="name">
                                            Nome da IA
                                            <i class="sort-icon bi bi-sort-alpha-down"></i>
                                        </th>
                                        <th scope="col" class="sortable d-none d-md-table-cell" data-sort-key="client">
                                            Cliente API
                                            <i class="sort-icon bi bi-sort-alpha-down"></i>
                                        </th>
                                        <th scope="col" class="sortable d-none d-md-table-cell" data-sort-key="model">
                                            Modelo
                                            <i class="sort-icon bi bi-sort-alpha-down"></i>
                                        </th>
                                        <th scope="col" class="sortable" data-sort-key="status">
                                            Status
                                            <i class="sort-icon bi bi-sort-numeric-down"></i>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="aiTable">
                                    {% for config in ai_configs %}
                                    <tr data-value="{{ config.name|lower }}">
                                        <th scope="row" data-value="{{ config.name|lower }}">
                                            <a href="{% url 'ai_config:ai_edit' config.id %}" class="text-decoration-none">
                                                {{ config.name }}
                                            </a>
                                            <!-- Informações extras para telas pequenas -->
                                            <div class="d-md-none mt-1">
                                                <small class="d-block text-muted">
                                                    <strong>Cliente:</strong> {{ config.ai_client }}
                                                </small>
                                                <small class="d-block text-muted">
                                                    <strong>Modelo:</strong> <span class="badge bg-secondary">{{ config.model_name }}</span>
                                                </small>
                                            </div>
                                        </th>
                                        <td class="d-none d-md-table-cell" data-value="{{ config.ai_client.id }}">
                                            {{ config.ai_client }}
                                        </td>
                                        <td class="d-none d-md-table-cell" data-value="{{ config.model_name }}">
                                            <span class="badge bg-secondary">{{ config.model_name }}</span>
                                        </td>
                                        <td data-value="{% if config.id in enabled_config_ids %}1{% else %}0{% endif %}">
                                            <div class="form-check form-switch">
                                                <input type="checkbox" 
                                                      class="form-check-input ai-toggle" 
                                                      id="toggle-{{ config.id }}" 
                                                      data-ai-id="{{ config.id }}" 
                                                      {% if config.id in enabled_config_ids %}checked{% endif %}>
                                                <span class="badge {% if config.id in enabled_config_ids %}bg-success{% else %}bg-secondary{% endif %}">
                                                    {% if config.id in enabled_config_ids %}Ativa{% else %}Inativa{% endif %}
                                                </span>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Paginação no estilo Bootswatch -->
                        <nav aria-label="Paginação da tabela de IAs" class="mt-3">
                            <ul class="pagination pagination-sm justify-content-center" id="pagination">
                                <li class="page-item disabled">
                                    <a class="page-link" href="#" id="prevPage" aria-label="Página anterior">
                                        <span aria-hidden="true">&laquo;</span>
                                    </a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="#" id="nextPage" aria-label="Próxima página">
                                        <span aria-hidden="true">&raquo;</span>
                                    </a>
                                </li>
                            </ul>
                        </nav>
                    </div>
                {% else %}
                    <!-- Feedback quando não há IAs configuradas usando alerta do Bootswatch -->
                    <div class="alert alert-info mt-3" role="alert">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-info-circle-fill me-2"></i>
                            <div>
                                <h5 class="alert-heading mb-1">Nenhuma IA Disponível</h5>
                                <p class="mb-0">Não há configurações de IA disponíveis para este token. Primeiro, crie uma configuração de IA na seção de gerenciamento de IAs.</p>
                            </div>
                        </div>
                        <div class="text-center mt-3">
                            <a href="{% url 'ai_config:ai_manage' %}" class="btn btn-primary">
                                <i class="bi bi-gear me-2"></i>Gerenciar IAs
                            </a>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmação -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmModalLabel">Confirmar Ação</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body" id="confirmModalBody">
                <!-- Mensagem será inserida dinamicamente -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="confirmModalAccept">Confirmar</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Adicionar variáveis para o modal no início do script
        const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
        const confirmModalBody = document.getElementById('confirmModalBody');
        const confirmModalAccept = document.getElementById('confirmModalAccept');
        
        // Função para salvar a configuração via AJAX
        function toggleAI(aiId, isActive) {
            const toggle = document.getElementById(`toggle-${aiId}`);
            const statusBadge = toggle.nextElementSibling;
            
            // Desabilita o switch e mostra "Salvando"
            toggle.disabled = true;
            statusBadge.innerHTML = `
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                Salvando...
            `;
            
            // CORREÇÃO: Modificando a estrutura do payload para evitar problemas com UUIDs
            const tokenId = "{{ token.id }}";
            const payload = {
                "token_config": {
                    "token_id": tokenId,
                    "ai_configs": {
                        [aiId]: isActive
                    }
                }
            };
            
            // Garantir que esteja enviando como JSON
            const options = {
                headers: {
                    'Content-Type': 'application/json',
                }
            };
            
            ajaxAPI("{% url 'ai_config:token_ai_toggle' %}", 'POST', payload, options)
            .then(response => {
                statusBadge.className = isActive
                    ? 'badge ms-2 bg-success'
                    : 'badge ms-2 bg-secondary';
                statusBadge.textContent = isActive ? 'Ativa' : 'Inativa';
                showMessage('success', 'IA ' + (isActive ? 'ativada' : 'desativada') + ' com sucesso!');
            })
            .catch(error => {
                console.error('Erro:', error);
                // Restaurar estado do switch em caso de erro
                toggle.checked = !isActive;
                statusBadge.className = !isActive
                    ? 'badge ms-2 bg-success'
                    : 'badge ms-2 bg-secondary';
                statusBadge.textContent = !isActive ? 'Ativa' : 'Inativa';
                
                if (error instanceof APIResponse) {
                    error.showMessage();
                } else {
                    showMessage('error', 'Erro ao processar solicitação. Tente novamente.');
                }
            })
            .finally(() => {
                toggle.disabled = false;
            });
        }
        
        // Função para ativar/desativar todas as IAs
        function toggleAllAIs(activate) {
            const actionText = activate ? 'ativar' : 'desativar';
            
            // Obter todas as IAs visíveis (filtradas)
            const visibleAIs = filteredRows.map(row => {
                const toggle = row.querySelector('.ai-toggle');
                if (toggle) return toggle.dataset.aiId;
                return null;
            }).filter(id => id);
            
            if (visibleAIs.length === 0) {
                showToast('warning', 'Nenhuma IA visível para processar.');
                return;
            }
            
            // Configurar e mostrar o modal
            confirmModalBody.innerHTML = `Tem certeza que deseja ${actionText} todas as IAs visíveis para este token?`;
            
            // Remover listener anterior do botão de confirmação
            const confirmButton = document.getElementById('confirmModalAccept');
            const oldButton = confirmButton.cloneNode(true);
            confirmButton.parentNode.replaceChild(oldButton, confirmButton);
            
            // Adicionar novo listener com referência preservada
            oldButton.addEventListener('click', function processToggleAll() {
                confirmModal.hide();
                
                // Remover o listener após o uso para evitar duplicação
                oldButton.removeEventListener('click', processToggleAll);
                
                // Desabilitar botões durante o processamento
                const activateBtn = document.getElementById('activateAllBtn');
                const deactivateBtn = document.getElementById('deactivateAllBtn');
                activateBtn.disabled = true;
                deactivateBtn.disabled = true;
                
                // Resto do código original da função
                const processToastId = showMessage('info', `<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Processando ${actionText} todas as IAs...`, 0, false);
                
                // CORREÇÃO: Modificando a estrutura do payload para evitar problemas com UUIDs
                const tokenId = "{{ token.id }}";
                const aiConfigs = {};
                
                // Adicionar cada AI visível ao payload
                visibleAIs.forEach(aiId => {
                    aiConfigs[aiId] = activate;
                });
                
                const payload = {
                    "token_config": {
                        "token_id": tokenId,
                        "ai_configs": aiConfigs
                    }
                };
                
                // Garantir que esteja enviando como JSON
                const options = {
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };
                
                ajaxAPI("{% url 'ai_config:token_ai_toggle' %}", 'POST', payload, options)
                .then(response => {
                    if (response.success) {
                        // Fechar o toast de processamento
                        closeMessage(processToastId);
                        
                        // Atualizar os switches e badges
                        visibleAIs.forEach(aiId => {
                            const toggle = document.getElementById(`toggle-${aiId}`);
                            if (!toggle) return;
                            
                            const statusBadge = toggle.nextElementSibling;
                            
                            toggle.checked = activate;
                            statusBadge.className = activate 
                                ? 'badge ms-2 bg-success' 
                                : 'badge ms-2 bg-secondary';
                            statusBadge.textContent = activate ? 'Ativa' : 'Inativa';
                            
                            // Atualizar o valor do atributo data-value
                            toggle.closest('td').setAttribute('data-value', activate ? '1' : '0');
                        });
                        
                        showMessage('success', `Todas as IAs foram ${activate ? 'ativadas' : 'desativadas'} com sucesso!`);
                        updateTable(); // Atualizar tabela para refletir as mudanças em filtros/ordenação
                    } else {
                        throw new Error(response.error || `Erro ao ${actionText} IAs`);
                    }
                })
                .catch(error => {
                    // Fechar o toast de processamento
                    closeMessage(processToastId);
                    
                    console.error('Erro:', error);
                    showMessage('danger', `Erro ao ${actionText} IAs: ${error.message}`);
                })
                .finally(() => {
                    // Re-habilitar botões
                    activateBtn.disabled = false;
                    deactivateBtn.disabled = false;
                });
            });
            
            confirmModal.show();
        }
        
        // Função para exibir toasts usando o sistema do base.html
        function showToast(type, message) {
            // Criar o elemento toast
            const toast = document.createElement('div');
            toast.className = `toast align-items-center border-0 text-bg-${type === 'danger' ? 'danger' : type}`;
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');
            toast.setAttribute('aria-atomic', 'true');
            toast.setAttribute('data-bs-delay', '5000');
            
            // Definir o conteúdo do toast
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            `;
            
            // Adicionar à container de toasts
            const toastContainer = document.querySelector('.toast-container');
            toastContainer.appendChild(toast);
            
            // Inicializar e mostrar o toast usando o Bootstrap
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
            
            // Auto-remover depois de fechado (para não acumular no DOM)
            toast.addEventListener('hidden.bs.toast', function() {
                this.remove();
            });
        }
        
        // Listeners para os switches
        document.querySelectorAll('.ai-toggle').forEach(toggle => {
            toggle.addEventListener('change', function() {
                const aiId = this.dataset.aiId;
                const isActive = this.checked;
                toggleAI(aiId, isActive);
            });
        });

        // Listeners para os botões de ativar/desativar todas
        document.getElementById('activateAllBtn')?.addEventListener('click', function() {
            toggleAllAIs(true);
        });
        
        document.getElementById('deactivateAllBtn')?.addEventListener('click', function() {
            toggleAllAIs(false);
        });

        // ----- CÓDIGO PARA GERENCIAMENTO DE TABELA -----
        
        let currentPage = 1;
        let itemsPerPage = parseInt(document.getElementById('itemsPerPage').value) || 10;
        let filteredRows = [];
        let sortKey = 'name';
        let sortDirection = 'asc';
        
        // Atualiza a tabela (filtros, ordenação, paginação)
        function updateTable() {
            const tbody = document.getElementById('aiTable');
            if (!tbody) return;
            
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            // Captura filtros
            const nameFilter = document.getElementById('filterName')?.value.toLowerCase() || '';
            const clientFilter = document.getElementById('filterClient')?.value || '';
            const statusFilter = document.getElementById('filterStatus')?.value || '';
            
            filteredRows = rows.filter(row => {
                const name = row.querySelector('th').textContent.toLowerCase();
                const client = row.querySelector('td[data-value]')?.getAttribute('data-value') || '';
                const status = row.querySelectorAll('td')[row.querySelectorAll('td').length-1]?.getAttribute('data-value') || '';
                
                const nameMatch = name.includes(nameFilter);
                const clientMatch = !clientFilter || client === clientFilter;
                const statusMatch = !statusFilter || status === statusFilter;
                
                return nameMatch && clientMatch && statusMatch;
            });
            
            sortTable();
            
            const totalItems = filteredRows.length;
            const totalCounter = document.getElementById('paginationTotal');
            if (totalCounter) totalCounter.textContent = totalItems;
            
            const totalPages = Math.max(1, Math.ceil(totalItems / itemsPerPage));
            
            if (currentPage > totalPages) {
                currentPage = totalPages;
            }
            
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, totalItems);
            
            const fromCounter = document.getElementById('paginationFrom');
            const toCounter = document.getElementById('paginationTo');
            
            if (fromCounter) fromCounter.textContent = totalItems === 0 ? 0 : startIndex + 1;
            if (toCounter) toCounter.textContent = endIndex;
            
            rows.forEach(row => row.style.display = 'none');
            filteredRows.slice(startIndex, endIndex).forEach(row => row.style.display = '');
            
            updatePagination(totalPages);
        }
        
        // Ordenação
        function sortTable() {
            const tbody = document.getElementById('aiTable');
            if (!tbody) return;
            
            filteredRows.sort((a, b) => {
                let aValue, bValue;
                
                if (sortKey === 'name') {
                    aValue = a.querySelector('th').getAttribute('data-value');
                    bValue = b.querySelector('th').getAttribute('data-value');
                } else if (sortKey === 'status') {
                    const aCell = a.querySelectorAll('td')[a.querySelectorAll('td').length-1];
                    const bCell = b.querySelectorAll('td')[b.querySelectorAll('td').length-1];
                    aValue = aCell ? aCell.getAttribute('data-value') : '0';
                    bValue = bCell ? bCell.getAttribute('data-value') : '0';
                } else {
                    // Encontrar a célula correspondente (cliente ou modelo)
                    const aCell = a.querySelector(`td[data-value][data-sort-key="${sortKey}"]`) || 
                                  Array.from(a.querySelectorAll('td')).find(cell => cell.getAttribute('data-value'));
                    const bCell = b.querySelector(`td[data-value][data-sort-key="${sortKey}"]`) || 
                                  Array.from(b.querySelectorAll('td')).find(cell => cell.getAttribute('data-value'));
                                  
                    aValue = aCell ? aCell.getAttribute('data-value') : '';
                    bValue = bCell ? bCell.getAttribute('data-value') : '';
                }
                
                // Comparação numérica para status
                if (sortKey === 'status') {
                    return sortDirection === 'asc'
                        ? Number(aValue) - Number(bValue)
                        : Number(bValue) - Number(aValue);
                }
                
                // Comparação de texto para outros campos
                return sortDirection === 'asc'
                    ? String(aValue).localeCompare(String(bValue))
                    : String(bValue).localeCompare(String(aValue));
            });
            
            // Atualiza ícones
            document.querySelectorAll('th.sortable').forEach(th => {
                const icon = th.querySelector('.sort-icon');
                if (!icon) return;
                
                const key = th.dataset.sortKey;
                
                th.classList.remove('active-sort');
                icon.classList.remove(
                    'bi-sort-alpha-down', 
                    'bi-sort-alpha-up',
                    'bi-sort-numeric-down', 
                    'bi-sort-numeric-up'
                );
                
                if (key === sortKey) {
                    const isNumeric = key === 'status';
                    if (sortDirection === 'asc') {
                        icon.classList.add(isNumeric ? 'bi-sort-numeric-down' : 'bi-sort-alpha-down');
                    } else {
                        icon.classList.add(isNumeric ? 'bi-sort-numeric-up' : 'bi-sort-alpha-up');
                    }
                    th.classList.add('active-sort');
                } else {
                    icon.classList.add(key === 'status' ? 'bi-sort-numeric-down' : 'bi-sort-alpha-down');
                }
            });

            filteredRows.forEach(row => tbody.appendChild(row));
        }

        // Atualizar paginação
        function updatePagination(totalPages) {
            const pagination = document.getElementById('pagination');
            if (!pagination) return;
            
            const prevPageBtn = pagination.querySelector('li:first-child');
            const nextPageBtn = pagination.querySelector('li:last-child');
            
            if (prevPageBtn) prevPageBtn.classList.toggle('disabled', currentPage <= 1);
            if (nextPageBtn) nextPageBtn.classList.toggle('disabled', currentPage >= totalPages);
            
            // Remover páginas existentes
            Array.from(pagination.querySelectorAll('li:not(:first-child):not(:last-child)')).forEach(li => li.remove());
            
            let pagesToShow = [];
            if (totalPages <= 5) {
                pagesToShow = Array.from({length: totalPages}, (_, i) => i + 1);
            } else {
                pagesToShow = [1];
                
                if (currentPage > 3) {
                    pagesToShow.push('...');
                }
                
                for (let i = Math.max(2, currentPage - 1); i <= Math.min(totalPages - 1, currentPage + 1); i++) {
                    pagesToShow.push(i);
                }
                
                if (currentPage < totalPages - 2) {
                    pagesToShow.push('...');
                }
                
                if (totalPages > 1) {
                    pagesToShow.push(totalPages);
                }
            }
            
            const nextPageElement = pagination.querySelector('li:last-child');
            if (!nextPageElement) return;
            
            pagesToShow.forEach(pageNum => {
                const li = document.createElement('li');
                
                if (pageNum === '...') {
                    li.className = 'page-item disabled';
                    li.innerHTML = '<span class="page-link">...</span>';
                } else {
                    li.className = `page-item ${currentPage === pageNum ? 'active' : ''}`;
                    li.innerHTML = `<a class="page-link" href="#" data-page="${pageNum}">${pageNum}</a>`;
                    
                    if (currentPage !== pageNum) {
                        li.querySelector('a').addEventListener('click', function(e) {
                            e.preventDefault();
                            currentPage = parseInt(this.dataset.page);
                            updateTable();
                        });
                    }
                }
                
                pagination.insertBefore(li, nextPageElement);
            });
        }
        
        // Event Listeners
        document.querySelectorAll('th.sortable').forEach(header => {
            header.addEventListener('click', function() {
                const key = this.dataset.sortKey;
                if (key === sortKey) {
                    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    sortKey = key;
                    sortDirection = 'asc';
                }
                
                sessionStorage.setItem('aiTableSortKey', sortKey);
                sessionStorage.setItem('aiTableSortDirection', sortDirection);
                
                updateTable();
            });
        });
        
        document.getElementById('prevPage')?.addEventListener('click', function(e) {
            e.preventDefault();
            if (currentPage > 1) {
                currentPage--;
                updateTable();
            }
        });
        
        document.getElementById('nextPage')?.addEventListener('click', function(e) {
            e.preventDefault();
            const totalPages = Math.ceil(filteredRows.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                updateTable();
            }
        });
        
        document.getElementById('itemsPerPage')?.addEventListener('change', function() {
            itemsPerPage = parseInt(this.value);
            currentPage = 1;
            sessionStorage.setItem('aiTableItemsPerPage', itemsPerPage);
            updateTable();
        });
        
        document.querySelectorAll('.filter').forEach(filter => {
            filter.addEventListener('input', function() {
                this.classList.toggle('is-valid', this.value !== '');
                currentPage = 1;
                updateTable();
            });
        });
        
        document.querySelector('.toggle-filters')?.addEventListener('click', function() {
            const filterControls = document.querySelector('#filterControls');
            if (!filterControls) return;
            
            const icon = this.querySelector('i:last-child');
            if (!icon) return;
            
            if (filterControls.style.display === 'none') {
                filterControls.style.display = 'block';
                icon.classList.replace('bi-chevron-up', 'bi-chevron-down');
            } else {
                filterControls.style.display = 'none';
                icon.classList.replace('bi-chevron-down', 'bi-chevron-up');
            }
            
            sessionStorage.setItem('aiTableFiltersVisible', filterControls.style.display !== 'none');
        });
        
        // Restaurar preferências
        function restoreUserPreferences() {
            const savedItemsPerPage = sessionStorage.getItem('aiTableItemsPerPage');
            const itemsPerPageSelect = document.getElementById('itemsPerPage');
            
            if (savedItemsPerPage && itemsPerPageSelect) {
                itemsPerPage = parseInt(savedItemsPerPage);
                if (itemsPerPageSelect.querySelector(`option[value="${itemsPerPage}"]`)) {
                    itemsPerPageSelect.value = savedItemsPerPage;
                }
            }
            
            const filtersVisible = sessionStorage.getItem('aiTableFiltersVisible');
            const filterControls = document.querySelector('#filterControls');
            const toggleFiltersIcon = document.querySelector('.toggle-filters i:last-child');
            
            if (filtersVisible === 'false' && filterControls && toggleFiltersIcon) {
                filterControls.style.display = 'none';
                toggleFiltersIcon.classList.replace('bi-chevron-down', 'bi-chevron-up');
            }
            
            const savedSortKey = sessionStorage.getItem('aiTableSortKey');
            const savedSortDirection = sessionStorage.getItem('aiTableSortDirection');
            
            if (savedSortKey && savedSortDirection) {
                sortKey = savedSortKey;
                sortDirection = savedSortDirection;
            }
            
            // Inicializar a tabela
            updateTable();
        }
        
        restoreUserPreferences();
    });
</script>
{% endblock %}
