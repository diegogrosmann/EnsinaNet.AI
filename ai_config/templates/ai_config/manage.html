{% extends 'base.html' %}

{% block content %}
<div class="container">
    <h2 class="mb-4">Configurações de IA para o Token "{{ token.name }}"</h2>

    <div class="mb-3">
        <a href="{% url 'ai_config:ai_config_create' token.id %}" class="btn btn-success">
            <i class="bi bi-plus-circle"></i> Criar Nova IA
        </a>
    </div>

    {% if ai_configs %}
    <div class="table-responsive card">
        <table class="table table-striped table-hover align-middle mb-0">
            <thead>
                <tr class="bg-primary text-white">
                    <th class="px-3 py-3">Nome da IA</th>
                    <th class="px-3 py-3">Cliente</th>
                    <th class="px-3 py-3">Modelo</th>
                    <th class="px-3 py-3">Status</th>
                    <th class="px-3 py-3 text-center">Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for config in ai_configs %}
                <tr>
                    <td class="px-3">{{ config.name }}</td>
                    <td class="px-3">{{ config.ai_client.api_client_class }}</td>
                    <td class="px-3">{{ config.model_name|default:"Padrão" }}</td>
                    <td class="px-3">
                        <div class="form-check form-switch">
                            <input type="checkbox" 
                                   class="form-check-input enable-checkbox" 
                                   data-config-id="{{ config.id }}"
                                   {% if config.enabled %}checked{% endif %}
                            >
                            <label class="form-check-label">
                                {{ config.enabled|yesno:"Ativo,Inativo" }}
                            </label>
                        </div>
                    </td>
                    <td class="px-3 text-center">
                        <div class="btn-group">
                            <a href="{% url 'ai_config:ai_config_edit' token.id config.id %}" 
                               class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-pencil"></i>
                            </a>
                            <a href="#" 
                               class="btn btn-sm btn-outline-danger delete-config"
                               data-config-id="{{ config.id }}"
                               data-config-name="{{ config.name }}">
                                <i class="bi bi-trash"></i>
                            </a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="alert alert-info">
        <i class="bi bi-info-circle me-2"></i>
        Nenhuma configuração de IA criada para este token.
    </div>
    {% endif %}

    <a href="{% url 'accounts:token_config' token.id %}" class="btn btn-secondary mt-3">
        <i class="bi bi-arrow-left"></i> Voltar
    </a>
</div>

<!-- Modal de Confirmação de Exclusão -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Exclusão</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja excluir "<strong id="configNameToDelete"></strong>"?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">
                    <i class="bi bi-trash3"></i> Sim, Excluir
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    /* Estilos para a tabela */
    .table {
        font-size: 0.95rem;
    }
    
    /* Melhora o contraste do cabeçalho */
    .table thead tr {
        background-color: #0d6efd !important;  /* Azul mais vibrante */
    }
    
    .table thead th {
        font-weight: 500;
        border-bottom: 0;
    }
    
    /* Hover mais suave nas linhas */
    .table tbody tr:hover {
        background-color: rgba(13, 110, 253, 0.05);
    }
    
    /* Melhor espaçamento para os switches */
    .form-switch {
        padding-left: 2.5em;
    }
    
    .form-check-input {
        cursor: pointer;
    }
    
    /* Melhora aparência dos botões de ação */
    .btn-group .btn {
        padding: 0.25rem 0.5rem;
    }
    
    .btn-group .btn i {
        font-size: 0.9rem;
    }
</style>

<script>
// Inicialização do Modal
let deleteModal;

document.addEventListener('DOMContentLoaded', function() {
    deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
});

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

document.querySelectorAll('.enable-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
        const configId = this.dataset.configId;
        const isEnabled = this.checked;
        const url = buildUrl("{% url 'ai_config:ai_config_toggle' token.id 9999999999 %}", "9999999999", configId);

        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ enabled: isEnabled }),
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Erro na requisição');
            }
            return response.json();
        })
        .then(data => {
            if (data.status !== 'success') {
                throw new Error('Erro na resposta');
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            this.checked = !isEnabled; // Reverte o estado em caso de erro
        });
    });
});

// Manipulação do Modal de Exclusão
let configIdToDelete = null;

document.querySelectorAll('.delete-config').forEach(button => {
    button.addEventListener('click', function(e) {
        e.preventDefault();
        configIdToDelete = this.dataset.configId;
        const configName = this.dataset.configName;
        document.getElementById('configNameToDelete').textContent = configName;
        deleteModal.show();
    });
});

document.getElementById('confirmDelete').addEventListener('click', function() {
    const url = buildUrl("{% url 'ai_config:ai_config_delete' token.id 9999999999 %}", "9999999999", configIdToDelete);

    fetch(url, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Erro na requisição');
        }
        return response.json();
    })
    .then(data => {
        if (data.status === 'success') {
            // Usa a função global showToast
            showToast(data.message, 'success');
            
            // Remove a linha da tabela
            const row = document.querySelector(`[data-config-id="${configIdToDelete}"]`).closest('tr');
            row.remove();
            
            // Se não houver mais configurações, recarrega a página
            const tbody = document.querySelector('tbody');
            if (!tbody.hasChildNodes()) {
                window.location.reload();
            }
        } else {
            throw new Error('Erro na exclusão');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        showToast('Erro ao excluir a configuração', 'error');
    })
    .finally(() => {
        deleteModal.hide();
    });
});
</script>
{% endblock %}
