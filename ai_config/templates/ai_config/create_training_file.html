<!-- ai_config/templates/ai_config/create_training_file.html -->

{% extends 'base.html' %}
{% load ai_config_tags %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        {% if training_file %}
            <h2>Editar Arquivo de Treinamento: {{ training_file.name }}</h2>
        {% else %}
            <h2>Criar Arquivo de Treinamento</h2>
        {% endif %}
        
        <!-- Card Colapsado para Captura de Consulta -->
        <div class="card mb-4">
            <div class="card-header" id="captureCardHeader">
                <h5 class="mb-0">
                    <button class="btn btn-link" type="button" data-bs-toggle="collapse" data-bs-target="#captureCardBody" aria-expanded="false" aria-controls="captureCardBody">
                        Ativar Captura de Consulta
                    </button>
                </h5>
            </div>
            <div id="captureCardBody" class="collapse">
                <div class="card-body">
                    <form id="capture-form" method="post">
                        {% csrf_token %}
                        {{ capture_form.as_p }}
                        <button type="button" id="toggle-capture-btn" class="btn btn-primary">Ativar Captura de Consulta</button>
                    </form>
                </div>
            </div>
        </div>
        
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            {{ form.media }}
            {{ formset.media }}
            <!-- Campo de Nome do Arquivo -->
            <div class="mb-3">
                {{ name_form.name.label_tag }}
                {{ name_form.name }}
                {% for error in name_form.name.errors %}
                    <small class="text-danger">{{ error }}</small>
                {% endfor %}
            </div>
            
            <!-- Formset de Exemplos -->
            {{ formset.management_form }}
            <div id="formset-container">
                {% for form in formset %}
                    <div class="card mb-3 formset-form">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <!-- Área de Colapso Separada -->
                            <div class="collapse-toggle" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#collapse{{ forloop.counter0 }}" aria-expanded="{% if forloop.first and not training_file %}true{% else %}false{% endif %}" aria-controls="collapse{{ forloop.counter0 }}">
                                <h5 class="mb-0">
                                    Exemplo {{ forloop.counter }}
                                    <i class="bi bi-chevron-down ms-2"></i>
                                </h5>
                            </div>
                            <!-- Botão Remover Independente -->
                            <button type="button" class="btn btn-danger btn-sm remove-form">Remover</button>
                        </div>
                        <div id="collapse{{ forloop.counter0 }}" class="collapse {% if forloop.first and not training_file %}show{% endif %}" aria-labelledby="heading{{ forloop.counter0 }}" data-bs-parent="#formset-container">
                            <div class="card-body">
                                <div class="mb-3" style="display: none;">
                                    {{ form.DELETE }}
                                </div>
                                <div class="mb-3">
                                    {{ form.system_message.label_tag }}
                                    {{ form.system_message }}
                                    {% for error in form.system_message.errors %}
                                        <small class="text-danger">{{ error }}</small>
                                    {% endfor %}
                                </div>
                                <div class="mb-3">
                                    {{ form.user_message.label_tag }}
                                    {{ form.user_message }}
                                    {% for error in form.user_message.errors %}
                                        <small class="text-danger">{{ error }}</small>
                                    {% endfor %}
                                </div>
                                <div class="mb-3">
                                    {{ form.response.label_tag }}
                                    {{ form.response }}
                                    {% for error in form.response.errors %}
                                        <small class="text-danger">{{ error }}</small>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                {% empty %}
                    <p>Nenhum exemplo adicionado.</p>
                {% endfor %}
            </div>
            <button type="button" id="add-form" class="btn btn-secondary">Adicionar Exemplo</button>
            
            <!-- Botões de Salvamento -->
            {% if training_file %}
                <button type="submit" name="save" class="btn btn-primary">Salvar Alterações</button>
                <button type="submit" name="save_and_continue" class="btn btn-primary">Salvar e Continuar Editando</button>
            {% else %}
                <button type="submit" name="save" class="btn btn-primary">Salvar Arquivo de Treinamento</button>
                <button type="submit" name="save_and_continue" class="btn btn-primary">Salvar e Continuar Editando</button>
            {% endif %}
        </form>
        <a href="{% url 'manage_tokens' %}" class="btn btn-secondary mt-3">Voltar para Gerenciar Tokens</a>
    </div>
</div>

<!-- Modal para mensagens -->
<div class="modal fade" id="captureModal" tabindex="-1" aria-labelledby="captureModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="captureModalLabel">Captura de Consulta</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body" id="captureModalBody">
        <!-- Mensagens serão inseridas via JavaScript -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        var formsetContainer = document.getElementById('formset-container');
        var addFormButton = document.getElementById('add-form');
        var totalForms = document.querySelector('[name="form-TOTAL_FORMS"]');
        var formNum = parseInt(totalForms.value);
        
        const toggleCaptureBtn = document.getElementById('toggle-capture-btn');
        const aiClientSelect = document.getElementById('id_capture-ai_client');
        const tokenSelect = document.getElementById('id_capture-token');
        let isCapturing = false;
        let selectedAIClientId = null;
        let selectedAIClientName = null;
        let selectedTokenId = null;
        
        toggleCaptureBtn.addEventListener('click', function() {
            selectedAIClientId = aiClientSelect.value;
            selectedAIClientName = aiClientSelect.options[aiClientSelect.selectedIndex].text;
            selectedTokenId = tokenSelect.value;
            
            if (!selectedAIClientId) {
                alert('Por favor, selecione uma IA para capturar consultas.');
                return;
            }
            
            if (!selectedTokenId) {
                alert('Por favor, selecione um Token para capturar consultas.');
                return;
            }
            
            if (!isCapturing) {
                // Iniciar a captura
                fetch("{% url 'ai_config:toggle_capture' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: new URLSearchParams({
                        'token_id': selectedTokenId,
                        'ai_client_id': selectedAIClientName,
                        'action': 'activate'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        isCapturing = true;
                        toggleCaptureBtn.textContent = 'Desativar Captura de Consulta';
                        showModal(data.message);
                    } else if (data.error) {
                        showModal(data.error);
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    showModal('Ocorreu um erro ao ativar a captura.');
                });
            } else {
                // Parar a captura
                fetch("{% url 'ai_config:toggle_capture' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: new URLSearchParams({
                        'token_id': selectedTokenId,
                        'ai_client_id': selectedAIClientName,
                        'action': 'deactivate'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        isCapturing = false;
                        toggleCaptureBtn.textContent = 'Ativar Captura de Consulta';
                        showModal(data.message);
                    } else if (data.error) {
                        showModal(data.error);
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    showModal('Ocorreu um erro ao desativar a captura.');
                });
            }
        });
    
        // Função para mostrar mensagens no modal
        function showModal(message) {
            const captureModal = new bootstrap.Modal(document.getElementById('captureModal'));
            document.getElementById('captureModalBody').textContent = message;
            captureModal.show();
        }
    
        // Parar a captura quando o usuário sair da página
        window.addEventListener('beforeunload', function (e) {
            if (isCapturing && selectedAIClientId && selectedTokenId) {
                navigator.sendBeacon("{% url 'ai_config:toggle_capture' %}", new URLSearchParams({
                    'token_id': selectedTokenId,
                    'ai_client_id': selectedAIClientName,
                    'action': 'deactivate'
                }));
            }
        });
    
        // Função para adicionar um novo formulário ao formset
        function addNewForm(system_message = '', user_message = '', response = '') {
            var emptyForm = document.querySelector('.formset-form').cloneNode(true);
            emptyForm.querySelector('.tox-tinymce').remove();
            var regex = new RegExp('form-(\\d+)-', 'g');
            emptyForm.innerHTML = emptyForm.innerHTML.replace(regex, 'form-' + formNum + '-');
            formNum++;
            totalForms.value = formNum;

            emptyForm.querySelector(`#id_form-${formNum-1}-system_message`).value = system_message;
            emptyForm.querySelector(`#id_form-${formNum-1}-user_message`).value = user_message;
            emptyForm.querySelector(`#id_form-${formNum-1}-response`).value = response;
            emptyForm.querySelector(`#id_form-${formNum-1}-DELETE`).value = false;

            emptyForm.querySelector(`#id_form-${formNum-1}-response`).style = '';

            // Atualizar o número do exemplo no cabeçalho
            var header = emptyForm.querySelector('.card-header .collapse-toggle h5');
            header.innerHTML = 'Exemplo ' + formNum + ' <i class="bi bi-chevron-up ms-2"></i>';
        
            // Atualizar o data-bs-target e aria-controls para o novo form
            var newCollapseId = 'collapse' + formNum;
            var newHeadingId = 'heading' + formNum;
        
            emptyForm.querySelector('.collapse-toggle').setAttribute('data-bs-target', '#' + newCollapseId);
            emptyForm.querySelector('.collapse-toggle').setAttribute('aria-controls', newCollapseId);
            emptyForm.querySelector('.collapse').id = newCollapseId;
            emptyForm.querySelector('.collapse').setAttribute('aria-labelledby', newHeadingId);
            emptyForm.querySelector('.collapse').classList.add('show');

            // Atualizar o atributo 'aria-expanded' para true
            emptyForm.querySelector('.collapse-toggle').setAttribute('aria-expanded', 'true');
            
            formsetContainer.appendChild(emptyForm);

            el = emptyForm.querySelector(`#id_form-${formNum-1}-response`);
            initTinyMCE(el);           
        }

        function initTinyMCE(el) {
            if (el.closest('.empty-form') === null) {  // Don't do empty inlines
            var mce_conf = JSON.parse(el.dataset.mceConf);

            // There is no way to pass a JavaScript function as an option
            // because all options are serialized as JSON.
            const fns = [
                'color_picker_callback',
                'file_browser_callback',
                'file_picker_callback',
                'images_dataimg_filter',
                'images_upload_handler',
                'paste_postprocess',
                'paste_preprocess',
                'setup',
                'urlconverter_callback',
            ];
            fns.forEach((fn_name) => {
                if (typeof mce_conf[fn_name] != 'undefined') {
                    if (mce_conf[fn_name].includes('(')) {
                        mce_conf[fn_name] = eval('(' + mce_conf[fn_name] + ')');
                    }
                    else {
                        mce_conf[fn_name] = window[mce_conf[fn_name]];
                    }
                }
            });

            // replace default prefix of 'empty-form' if used in selector
            if (mce_conf.selector && mce_conf.selector.includes('__prefix__')) {
                mce_conf.selector = `#${el.id}`;
            }
            else if (!('selector' in mce_conf)) {
                mce_conf['target'] = el;
            }
            if (el.dataset.mceGzConf) {
                tinyMCE_GZ.init(JSON.parse(el.dataset.mceGzConf));
            }
            if (!tinyMCE.get(el.id)) {
                tinyMCE.init(mce_conf);
            }
            }
        }

    
        // Atualizar a lista de exemplos em tempo real
        setInterval(function() {
            if (isCapturing && selectedTokenId && selectedAIClientName) {
                fetch(`/ai-config/get-training-examples/${selectedTokenId}/${selectedAIClientName}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.examples && data.examples.length > 0) {
                        data.examples.forEach((example) => {
                            addNewForm(example.system_message, example.user_message, example.response);
                        });
                    }
                })
                .catch(error => {
                    console.error('Erro ao buscar exemplos:', error);
                });
            }
        }, 5000); // Atualiza a cada 5 segundos
    
        addFormButton.addEventListener('click', function(e) {
            e.preventDefault();
            addNewForm(); // Adiciona um formulário vazio
        });
        
        formsetContainer.addEventListener('click', function(e) {
            if (e.target && e.target.matches('.remove-form')) {
                e.preventDefault();
                var formToRemove = e.target.closest('.formset-form');
                
                // Verifica se o form a ser removido já existe na base de dados (edição)
                // Se sim, marca o checkbox DELETE
                var deleteInput = formToRemove.querySelector('input[type="checkbox"][name$="-DELETE"]');
                if (deleteInput) {
                    deleteInput.checked = true;
                    // Esconder o formulário visualmente
                    formToRemove.style.display = 'none';
                } else {
                    // Se for um novo formulário (criação), simplesmente remove do DOM
                    formToRemove.remove();
                    formNum--;
                    totalForms.value = formNum;
        
                    // Re-numerar os formulários
                    var forms = formsetContainer.querySelectorAll('.formset-form');
                    forms.forEach(function(form, index) {
                        var currentIndex = index;
                        var regex = new RegExp('form-(\\d+)-', 'g');
                        form.innerHTML = form.innerHTML.replace(regex, 'form-' + index + '-');
        
                        // Atualizar o número do exemplo no cabeçalho
                        var header = form.querySelector('.card-header .collapse-toggle h5');
                        header.innerHTML = 'Exemplo ' + (index + 1) + ' <i class="bi bi-chevron-down ms-2"></i>';
        
                        // Atualizar os atributos de controle de colapso
                        var collapseId = 'collapse' + index;
                        form.querySelector('.collapse-toggle').setAttribute('data-bs-target', '#' + collapseId);
                        form.querySelector('.collapse-toggle').setAttribute('aria-controls', collapseId);
                        form.querySelector('.collapse').id = collapseId;
                        form.querySelector('.collapse').setAttribute('aria-labelledby', 'heading' + index);
        
                        // Atualizar o evento de colapso
                        var headerCard = form.querySelector('.collapse-toggle');
                        headerCard.removeEventListener('click', null); // Remove qualquer ouvinte existente
                        headerCard.addEventListener('click', function() {
                            var collapseElement = document.getElementById(collapseId);
                            var bsCollapse = new bootstrap.Collapse(collapseElement, {
                                toggle: true
                            });
                        });
        
                        // Atualizar o ícone
                        var icon = form.querySelector('.collapse-toggle i');
                        if (icon) {
                            icon.classList.remove('bi-chevron-up');
                            icon.classList.add('bi-chevron-down');
                        }
                    });
                }
            }
        });
        
        // Atualizar ícones de collapse
        var collapseElements = document.querySelectorAll('.collapse');
        collapseElements.forEach(function(collapseEl, index) {
            collapseEl.addEventListener('show.bs.collapse', function () {
                var button = collapseEl.previousElementSibling.querySelector('.collapse-toggle i');
                if (button) {
                    button.classList.remove('bi-chevron-down');
                    button.classList.add('bi-chevron-up');
                }
            });
        
            collapseEl.addEventListener('hide.bs.collapse', function () {
                var button = collapseEl.previousElementSibling.querySelector('.collapse-toggle i');
                if (button) {
                    button.classList.remove('bi-chevron-up');
                    button.classList.add('bi-chevron-down');
                }
            });
        });
        
    });
</script>
{% endblock %}